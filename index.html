<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MyLocalPDF â€” The Editor That Never Sees Your Files</title>
<meta name="description" content="100% client-side PDF editor. Merge, split, fill forms, compress, convert. Zero uploads, maximum privacy."/>
<meta name="keywords" content="PDF editor, local PDF, privacy, merge PDF, split PDF, form filler, compress PDF"/>
<meta name="author" content="MyLocalPDF"/>
<meta property="og:title" content="MyLocalPDF â€” Privacy-First PDF Editor"/>
<meta property="og:description" content="Edit PDFs locally in your browser. No uploads, no tracking, no limits."/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>

<style>
:root {
  --bg:       #080810;
  --surface:  #0f0f1a;
  --panel:    #13131f;
  --border:   #1e1e30;
  --border2:  #2a2a40;
  --amber:    #f59e0b;
  --amber2:   #fbbf24;
  --amber-dim:#7c4f06;
  --green:    #10b981;
  --red:      #ef4444;
  --blue:     #3b82f6;
  --text:     #e8e8f0;
  --text2:    #8888aa;
  --text3:    #444466;
  --radius:   8px;
  --toolbar-h:56px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* â”€â”€â”€ TOP HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  height: 52px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 16px;
  z-index: 100;
  flex-shrink: 0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 16px;
  letter-spacing: -0.3px;
  color: var(--text);
  white-space: nowrap;
  cursor: pointer;
}
.logo .dot { color: var(--amber); }

.header-sep { flex:1; }

.badge-local {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: rgba(16,185,129,0.1);
  border: 1px solid rgba(16,185,129,0.25);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  color: var(--green);
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.3px;
}
.badge-local .dot-live {
  width: 6px; height: 6px;
  background: var(--green);
  border-radius: 50%;
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.net-monitor {
  display: flex;
  align-items: center;
  gap: 5px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text3);
  padding: 4px 10px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 6px;
}
.net-monitor .count { color: var(--green); font-weight: 600; }

.nav-links {
  display: flex;
  gap: 4px;
  align-items: center;
}
.nav-link {
  padding: 6px 12px;
  color: var(--text2);
  font-size: 12px;
  font-weight: 500;
  text-decoration: none;
  border-radius: 6px;
  transition: all 0.15s;
}
.nav-link:hover { color: var(--amber); background: rgba(245,158,11,0.07); }

.btn-tools {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: var(--panel);
  border: 1px solid var(--border2);
  color: var(--text2);
  font-size: 12px;
  font-weight: 700;
  font-family: 'Syne', sans-serif;
  border-radius: 6px;
  cursor: pointer;
  letter-spacing: 0.3px;
  transition: all 0.2s;
}
.btn-tools:hover { border-color: var(--amber); color: var(--amber); background: rgba(245,158,11,0.07); }

/* â”€â”€â”€ AD BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ad-banner {
  background: linear-gradient(90deg, var(--surface) 0%, var(--panel) 50%, var(--surface) 100%);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  text-align: center;
  font-size: 12px;
  color: var(--text2);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}
.ad-banner .ad-label {
  background: var(--amber);
  color: #000;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
}
.ad-banner .ad-close {
  margin-left: auto;
  cursor: pointer;
  opacity: 0.5;
  transition: opacity 0.2s;
}
.ad-banner .ad-close:hover { opacity: 1; }

/* â”€â”€â”€ TOOLS HUB MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tools-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}
.tool-card {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 14px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: left;
  position: relative;
}
.tool-card:hover { border-color: var(--amber); background: rgba(245,158,11,0.04); }
.tool-card.pro-card:hover { border-color: var(--blue); background: rgba(59,130,246,0.04); }
.tool-card .tc-icon { font-size: 22px; }
.tool-card .tc-title {
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
}
.tool-card .tc-desc { font-size: 11px; color: var(--text2); line-height: 1.4; }
.tool-card .pro-badge {
  position: absolute;
  top: 8px; right: 8px;
  background: rgba(59,130,246,0.15);
  border: 1px solid rgba(59,130,246,0.3);
  color: var(--blue);
  font-size: 9px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  padding: 2px 6px;
  border-radius: 4px;
  letter-spacing: 0.5px;
}

/* Merge tool UI */
.merge-drop-area {
  border: 2px dashed var(--border2);
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 12px;
}
.merge-drop-area:hover { border-color: var(--amber); background: rgba(245,158,11,0.03); }
.merge-file-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 12px;
}
.merge-file-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 7px 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text2);
  gap: 8px;
  cursor: grab;
}
.merge-file-item .mf-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.merge-file-item .mf-pages { color: var(--text3); white-space: nowrap; }
.merge-file-item .mf-del { color: var(--red); cursor: pointer; font-size: 14px; line-height: 1; flex-shrink: 0; }
.merge-file-item .mf-del:hover { opacity: 0.7; }

/* Split tool */
.split-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 12px;
  max-height: 180px;
  overflow-y: auto;
  padding: 4px;
}
.split-page-chip {
  padding: 4px 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text3);
  cursor: pointer;
  transition: all 0.12s;
  user-select: none;
}
.split-page-chip.selected {
  background: rgba(245,158,11,0.12);
  border-color: var(--amber);
  color: var(--amber);
}

/* Bates numbering */
.bates-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}
.bates-field label {
  display: block;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text3);
  margin-bottom: 4px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.bates-field input, .bates-field select {
  width: 100%;
  padding: 7px 10px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 6px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  outline: none;
}
.bates-field input:focus, .bates-field select:focus { border-color: var(--amber); }
.bates-preview {
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  color: var(--amber);
  margin-bottom: 12px;
}

/* Modal wider variant */
.modal.wide { max-width: 600px; }

/* img2pdf file list */
.img2pdf-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
  max-height: 140px;
  overflow-y: auto;
}
.img2pdf-thumb {
  position: relative;
  width: 70px; height: 70px;
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid var(--border2);
  flex-shrink: 0;
}
.img2pdf-thumb img { width: 100%; height: 100%; object-fit: cover; }
.img2pdf-thumb .it-del {
  position: absolute; top: 2px; right: 2px;
  width: 16px; height: 16px;
  background: var(--red);
  color: #fff; border: none; border-radius: 50%;
  font-size: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  line-height: 1;
}

.btn-pro {
  padding: 6px 14px;
  background: linear-gradient(135deg, var(--amber) 0%, #d97706 100%);
  color: #000;
  font-size: 12px;
  font-weight: 700;
  font-family: 'Syne', sans-serif;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  letter-spacing: 0.3px;
  transition: all 0.2s;
}
.btn-pro:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-pro.active { background: linear-gradient(135deg,var(--green),#059669); color:#fff; }

/* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: 200px;
  min-width: 200px;
  max-width: 200px;
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  height: 100%;
  min-height: 0;
  overflow: hidden;
}

.sidebar-header {
  padding: 12px 14px;
  font-size: 10px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text3);
  letter-spacing: 1.5px;
  border-bottom: 1px solid var(--border);
  text-transform: uppercase;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.page-thumbs {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  scroll-behavior: smooth;
}

.page-thumbs::-webkit-scrollbar { width: 4px; }
.page-thumbs::-webkit-scrollbar-track { background: transparent; }
.page-thumbs::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
.page-thumbs::-webkit-scrollbar-thumb:hover { background: var(--amber); }

.thumb-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  display: flex;
  flex-direction: column;
}
.thumb-item:hover { border-color: var(--border2); }
.thumb-item.active { border-color: var(--amber); box-shadow: 0 0 0 1px var(--amber-dim); }

/* Constrained preview area â€” page renders inside, letterboxed */
.thumb-preview {
  width: 100%;
  height: 100px;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}
.thumb-canvas {
  max-width: 100%;
  max-height: 100px;
  display: block;
  object-fit: contain;
}

/* Always-visible bottom bar with page number + action buttons */
.thumb-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 6px;
  background: var(--panel);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  gap: 4px;
}
.thumb-label {
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text3);
  flex: 1;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.thumb-item.active .thumb-label { color: var(--amber); }

.sidebar-footer {
  padding: 12px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.usage-bar {
  margin-bottom: 8px;
}
.usage-label {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text3);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 5px;
}
.usage-track {
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}
.usage-fill {
  height: 100%;
  background: var(--amber);
  border-radius: 2px;
  transition: width 0.3s;
}

/* â”€â”€â”€ WORKSPACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.workspace {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  background: #0c0c18;
  background-image: radial-gradient(circle at 50% 0%, #1a1a30 0%, transparent 60%);
}

/* â”€â”€â”€ FLOATING TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  position: absolute;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 50;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 6px 8px;
  display: flex;
  align-items: center;
  gap: 4px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.04) inset;
  backdrop-filter: blur(10px);
  flex-wrap: wrap;
  max-width: 95%;
}

.tool-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 7px 12px;
  border-radius: 8px;
  border: none;
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  font-size: 10px;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  transition: all 0.15s;
  letter-spacing: 0.2px;
  white-space: nowrap;
}
.tool-btn svg { width:16px; height:16px; flex-shrink:0; }
.tool-btn:hover { background: var(--panel); color: var(--text); }
.tool-btn.active { background: rgba(245,158,11,0.15); color: var(--amber); border: 1px solid rgba(245,158,11,0.3); }

.tool-sep {
  width: 1px; height: 28px;
  background: var(--border);
  margin: 0 4px;
}

.btn-apply {
  padding: 7px 16px;
  background: var(--amber);
  color: #000;
  font-weight: 700;
  font-size: 12px;
  font-family: 'Syne', sans-serif;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  letter-spacing: 0.3px;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-apply:hover { background: var(--amber2); transform: translateY(-1px); }
.btn-apply:disabled { opacity:0.4; cursor:not-allowed; transform:none; }

/* â”€â”€â”€ CANVAS AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.canvas-scroll {
  flex: 1;
  overflow: auto;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 88px 40px 40px;
}

.canvas-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
.canvas-scroll::-webkit-scrollbar-track { background: transparent; }
.canvas-scroll::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

.page-wrapper {
  position: relative;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05);
  border-radius: 4px;
  overflow: visible;
  display: inline-block;
  flex-shrink: 0;
  margin: 20px;
}

#pdf-bg-canvas {
  display: block;
  position: relative;
  z-index: 1;
}

#overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 2;
  cursor: crosshair;
}

/* Annotation elements */
.annotation {
  position: absolute;
  z-index: 3;
  cursor: move;
  user-select: none;
}
.annotation.text-ann {
  background: transparent;
  border: 1px dashed rgba(245,158,11,0.4);
  padding: 4px 6px;
  min-width: 60px;
  min-height: 20px;
  color: #000;
  font-size: 14px;
  line-height: 1.4;
  cursor: move;
  outline: none;
  white-space: pre-wrap;
  border-radius: 2px;
  font-family: Helvetica, Arial, sans-serif;
  resize: both;
  overflow: auto;
}
.annotation.text-ann:focus,
.annotation.text-ann.editing {
  border-color: var(--amber);
  cursor: text;
  background: rgba(255,255,255,0.95);
}
/* Double-click hint shown on hover when not editing */
.annotation.text-ann:not(.editing)::after {
  content: 'âœ dbl-click to edit â€¢ drag corner to resize';
  position: absolute;
  bottom: calc(100% + 4px);
  left: 0;
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--amber);
  background: rgba(8,8,16,0.85);
  padding: 2px 6px;
  border-radius: 3px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 20;
}
.annotation.text-ann:not(.editing):hover::after {
  opacity: 1;
}
.annotation.rect-ann {
  background: white;
  border: none;
}
.annotation.img-ann {
  border: 1px dashed rgba(245,158,11,0.4);
  overflow: hidden;
  resize: both;
}
.annotation.img-ann img { width:100%; height:100%; object-fit:contain; display:block; }
/* â”€â”€â”€ V2: FIGMA-STYLE SELECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.annotation.selected {
  outline: none;
  box-shadow: 0 0 0 2px #2563eb, 0 4px 16px rgba(37,99,235,0.25);
}
.annotation:hover:not(.selected) {
  box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
}

/* Corner handle system */
.corner-handle {
  position: absolute;
  width: 8px; height: 8px;
  background: #fff;
  border: 2px solid #2563eb;
  border-radius: 2px;
  z-index: 12;
  display: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.annotation.selected .corner-handle,
.annotation:hover .corner-handle { display: block; }
.corner-handle.tl { top: -4px; left: -4px; cursor: nw-resize; }
.corner-handle.tr { top: -4px; right: -4px; cursor: ne-resize; }
.corner-handle.bl { bottom: -4px; left: -4px; cursor: sw-resize; }
.corner-handle.br { bottom: -4px; right: -4px; cursor: se-resize; }

/* Selection label chip */
.ann-type-chip {
  position: absolute;
  top: -22px; left: 0;
  background: #2563eb;
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  padding: 2px 6px;
  border-radius: 3px;
  letter-spacing: 0.5px;
  display: none;
  white-space: nowrap;
  pointer-events: none;
}
.annotation.selected .ann-type-chip { display: block; }

.ann-delete {
  position: absolute;
  top: -10px; right: -10px;
  width: 18px; height: 18px;
  background: var(--red);
  color: #fff;
  border: none;
  border-radius: 50%;
  font-size: 11px;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10;
  line-height: 1;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  transition: transform 0.1s;
}
.ann-delete:hover { transform: scale(1.2); }
.annotation:hover .ann-delete,
.annotation.selected .ann-delete { display: flex; }

/* Resize handle â€” legacy bottom-right (still used for images) */
.resize-handle {
  position: absolute;
  bottom: -4px; right: -4px;
  width: 10px; height: 10px;
  background: #2563eb;
  border: 2px solid #fff;
  border-radius: 2px;
  cursor: se-resize;
  display: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.annotation:hover .resize-handle,
.annotation.selected .resize-handle { display: block; }

/* â”€â”€â”€ V2: EDIT-TEXT TOOL ACTIVE STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tool-btn.active.edit-text-tool {
  background: rgba(37,99,235,0.15);
  color: #60a5fa;
  border: 1px solid rgba(37,99,235,0.4);
}

/* Font-match indicator */
.font-match-badge {
  display: none;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  background: rgba(16,185,129,0.12);
  border: 1px solid rgba(16,185,129,0.3);
  border-radius: 4px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--green);
  white-space: nowrap;
}
.font-match-badge.show { display: flex; }
.font-match-badge .fm-icon { font-size: 11px; }

/* â”€â”€â”€ ZOOM CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.zoom-bar {
  display: flex;
  align-items: center;
  gap: 0;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 8px;
  overflow: hidden;
}
.zoom-btn {
  padding: 6px 10px;
  background: transparent;
  border: none;
  color: var(--text2);
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  transition: all 0.15s;
  font-weight: 600;
}
.zoom-btn:hover { background: var(--panel); color: var(--text); }
.zoom-level {
  padding: 5px 10px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
  color: var(--amber);
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
  min-width: 46px;
  text-align: center;
  cursor: default;
}
.zoom-fit {
  padding: 5px 8px;
  background: transparent;
  border: none;
  color: var(--text3);
  cursor: pointer;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  transition: all 0.15s;
  border-left: 1px solid var(--border);
  letter-spacing: 0.3px;
}
.zoom-fit:hover { color: var(--text); background: var(--panel); }

/* â”€â”€â”€ UNDO/REDO BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.history-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 30px; height: 30px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text3);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.15s;
}
.history-btn:hover:not(:disabled) { border-color: var(--border2); color: var(--text); background: var(--panel); }
.history-btn:disabled { opacity: 0.25; cursor: not-allowed; }
.history-btn svg { width: 14px; height: 14px; }

/* â”€â”€â”€ PAGE ACTIONS (sidebar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.thumb-item .page-actions {
  display: flex;
  gap: 3px;
  flex-shrink: 0;
}
.page-act-btn {
  width: 18px; height: 18px;
  border-radius: 4px;
  border: 1px solid var(--border2);
  background: var(--surface);
  display: flex; align-items: center; justify-content: center;
  font-size: 10px;
  cursor: pointer;
  line-height: 1;
  transition: all 0.15s;
  color: var(--text3);
  flex-shrink: 0;
}
.page-act-btn.del:hover { background: var(--red); border-color: var(--red); color: #fff; }
.page-act-btn.rot:hover { background: var(--blue); border-color: var(--blue); color: #fff; }

/* drag-over thumb highlight */
.thumb-item.drag-over {
  border-color: var(--amber) !important;
  background: rgba(245,158,11,0.08) !important;
}
.thumb-item.dragging-thumb { opacity: 0.4; }

/* drag handle indicator */
.thumb-drag-handle {
  font-size: 9px;
  color: var(--text3);
  opacity: 0.5;
  pointer-events: none;
  flex-shrink: 0;
}
.thumb-item:hover .thumb-drag-handle { opacity: 1; }

/* page-count badge in sidebar header */
.page-count-badge {
  font-size: 10px;
  color: var(--amber);
  font-family: 'JetBrains Mono', monospace;
}

/* â”€â”€â”€ DROPZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dropzone {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  z-index: 10;
}

.drop-card {
  background: var(--panel);
  border: 2px dashed var(--border2);
  border-radius: 16px;
  padding: 48px 64px;
  text-align: center;
  transition: all 0.2s;
  max-width: 440px;
}
.drop-card:hover, .drop-card.dragging {
  border-color: var(--amber);
  background: rgba(245,158,11,0.04);
}

.drop-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
}

.drop-title {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text);
}

.drop-sub {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.5;
  margin-bottom: 24px;
}

.btn-open {
  padding: 10px 24px;
  background: var(--amber);
  color: #000;
  font-weight: 700;
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.3px;
}
.btn-open:hover { background: var(--amber2); transform: translateY(-1px); }

.privacy-pills {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}
.pill {
  padding: 4px 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11px;
  color: var(--text3);
  font-family: 'JetBrains Mono', monospace;
}

/* â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s;
  overflow-y: auto;
  padding: 20px;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

.modal {
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 16px;
  padding: 32px;
  max-width: 480px;
  width: 90%;
  box-shadow: 0 24px 64px rgba(0,0,0,0.6);
  max-height: 90vh;
  overflow-y: auto;
}

.modal h2 {
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 8px;
  color: var(--text);
}
.modal p { font-size: 13px; color: var(--text2); line-height: 1.6; margin-bottom: 20px; }

.modal input, .modal textarea, .modal select {
  width: 100%;
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 8px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  margin-bottom: 12px;
  outline: none;
  transition: border-color 0.2s;
}
.modal input:focus, .modal textarea:focus, .modal select:focus { border-color: var(--amber); }

.modal-btns { display: flex; gap: 8px; justify-content: flex-end; }
.btn-cancel {
  padding: 8px 16px;
  background: transparent;
  border: 1px solid var(--border2);
  color: var(--text2);
  border-radius: 8px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-cancel:hover { border-color: var(--text2); color: var(--text); }

.btn-confirm {
  padding: 8px 18px;
  background: var(--amber);
  color: #000;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  font-size: 13px;
  font-family: 'Syne', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-confirm:hover { background: var(--amber2); }

.pro-features {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 20px;
}
.pro-feat {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 12px;
  color: var(--text2);
}
.pro-feat .icon { font-size: 16px; flex-shrink: 0; }

/* â”€â”€â”€ STATUS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.statusbar {
  height: 26px;
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 14px;
  gap: 16px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text3);
  flex-shrink: 0;
}
.statusbar .sep { width:1px; height:12px; background:var(--border); }
.statusbar .highlight { color: var(--green); }
.statusbar .warn { color: var(--amber); }

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container {
  position: fixed;
  bottom: 40px;
  right: 20px;
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 10px 16px;
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 8px;
  font-size: 12px;
  color: var(--text);
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  animation: slideIn 0.3s, fadeOut 0.3s 2.7s forwards;
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 300px;
  pointer-events: all;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error   { border-left: 3px solid var(--red); }
.toast.info    { border-left: 3px solid var(--amber); }
@keyframes slideIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
@keyframes fadeOut { from{opacity:1} to{opacity:0} }

/* â”€â”€â”€ TEXT STYLE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.text-options {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 0 8px;
}
.text-options.show { display: flex; }
.text-options select,
.text-options input[type="color"],
.text-options input[type="number"] {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 6px;
  color: var(--text);
  padding: 4px 8px;
  font-size: 11px;
  font-family: 'Inter', sans-serif;
  outline: none;
  cursor: pointer;
}
.text-options input[type="color"] { width:32px; height:28px; padding:2px; cursor:pointer; }
.text-options input[type="number"] { width:50px; }

/* Loading overlay */
.loading-overlay {
  position: absolute;
  inset: 0;
  background: rgba(8,8,16,0.8);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 20;
  gap: 16px;
}
.spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--border2);
  border-top-color: var(--amber);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text2); }

.progress-bar { width: 200px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--amber); width: 0%; transition: width 0.3s; border-radius: 2px; }

/* Scan lines decoration */
.workspace::before {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.005) 2px, rgba(255,255,255,0.005) 4px);
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€â”€ CLOSE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-close {
  display: none;
  align-items: center;
  justify-content: center;
  width: 32px; height: 32px;
  background: transparent;
  border: 1px solid var(--border2);
  color: var(--text2);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}
.btn-close:hover { background: var(--red); border-color: var(--red); color: white; }

/* â”€â”€â”€ ORGANISER GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.org-grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 16px;
  max-height: 58vh;
  overflow-y: auto;
  padding: 8px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 16px;
}
.org-grid-container::-webkit-scrollbar { width: 4px; }
.org-grid-container::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.org-card {
  background: var(--surface);
  border: 2px solid var(--border2);
  border-radius: 8px;
  overflow: hidden;
  cursor: grab;
  position: relative;
  transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
  display: flex;
  flex-direction: column;
  user-select: none;
}
.org-card:hover { border-color: var(--amber); transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
.org-card.dragging { opacity: 0.35; border: 2px dashed var(--text2); transform: scale(0.97); }
.org-card.drag-target { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(59,130,246,0.4); }

.org-thumb-wrap {
  width: 100%;
  height: 160px;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}
.org-thumb-wrap canvas {
  max-width: 100%;
  max-height: 100%;
  display: block;
  object-fit: contain;
  transition: transform 0.2s;
}

.org-card-bar {
  padding: 7px 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 1px solid var(--border2);
  background: var(--panel);
  flex-shrink: 0;
}
.org-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text2);
  font-weight: 700;
  letter-spacing: 0.3px;
}
.org-actions { display: flex; gap: 4px; }
.org-btn {
  width: 22px; height: 22px;
  border: 1px solid var(--border2);
  background: var(--surface);
  color: var(--text3);
  border-radius: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.15s;
  line-height: 1;
}
.org-btn:hover { background: var(--border2); color: var(--text); }
.org-btn.del:hover { background: var(--red); border-color: var(--red); color: white; }
.org-btn.rot:hover { background: var(--blue); border-color: var(--blue); color: white; }

/* â”€â”€â”€ LIMIT BADGES on tool cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tc-limit {
  position: absolute;
  bottom: 8px; right: 8px;
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  padding: 2px 6px;
  border-radius: 4px;
  letter-spacing: 0.3px;
  font-weight: 700;
}
.tc-limit.free { background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.3); color: var(--green); }
.tc-limit.limited { background: rgba(245,158,11,0.12); border: 1px solid rgba(245,158,11,0.3); color: var(--amber); }
.tc-limit.exhausted { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.3); color: var(--red); }

/* â”€â”€â”€ HOURLY LIMIT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.limit-meters {
  display: flex;
  flex-direction: column;
  gap: 6px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 12px;
}
.limit-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.limit-row-label {
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text3);
  width: 70px;
  flex-shrink: 0;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.limit-track {
  flex: 1;
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}
.limit-fill {
  height: 100%;
  background: var(--green);
  border-radius: 2px;
  transition: width 0.3s;
}
.limit-fill.warn { background: var(--amber); }
.limit-fill.full { background: var(--red); }
.limit-count {
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text3);
  white-space: nowrap;
  min-width: 28px;
  text-align: right;
}

/* â”€â”€â”€ PRO MODAL UPGRADE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pay-methods {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.pay-btn {
  flex: 1;
  min-width: 120px;
  padding: 10px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 8px;
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.pay-btn:hover { border-color: var(--amber); color: var(--amber); }
.pay-btn .pay-icon { font-size: 20px; }
.pay-btn .pay-price { font-size: 16px; font-weight: 700; font-family: 'Syne', sans-serif; color: var(--text); }
.pay-btn .pay-label { font-size: 10px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }

/* â”€â”€â”€ WATERMARK MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wm-preview-box {
  position: relative;
  width: 100%;
  height: 100px;
  background: #fff;
  border: 1px solid var(--border2);
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.wm-preview-text {
  font-size: 22px;
  font-weight: 900;
  color: rgba(0,0,0,0.15);
  transform: rotate(-35deg);
  white-space: nowrap;
  letter-spacing: 2px;
  pointer-events: none;
  user-select: none;
}

/* â”€â”€â”€ HIGHLIGHT ANNOTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.annotation.highlight-ann {
  background: rgba(255, 235, 59, 0.35);
  border: 1px dashed rgba(255,200,0,0.6);
  border-radius: 2px;
  mix-blend-mode: multiply;
}

/* â”€â”€â”€ REDACT ANNOTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.annotation.redact-ann {
  background: #000;
  border: none;
}

/* Quick tools in dropzone */
.quick-tools-bar {
  margin-top: 20px;
  border-top: 1px solid var(--border);
  padding-top: 16px;
  width: 100%;
  text-align: center;
}
.quick-tools-label {
  font-size: 10px;
  color: var(--text3);
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 1px;
  margin-bottom: 10px;
}
.quick-tools-row {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

/* â”€â”€â”€ FORM FILLING MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-field-list {
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 16px;
}
.form-field-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
}
.form-field-item label {
  display: block;
  font-size: 11px;
  color: var(--text3);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-field-item input,
.form-field-item select {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: 6px;
  color: var(--text);
  font-size: 13px;
  margin-bottom: 0;
}
.form-field-item .field-type {
  font-size: 10px;
  color: var(--amber);
  margin-left: 8px;
}
.saved-data-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 16px;
}
.saved-data-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 10px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
}
.saved-data-item:hover {
  border-color: var(--amber);
  background: rgba(245,158,11,0.05);
}
.saved-data-item .sd-label {
  color: var(--text3);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.saved-data-item .sd-value {
  color: var(--text);
  font-weight: 500;
}

/* â”€â”€â”€ USAGE ANALYTICS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.analytics-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
.analytics-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
}
.analytics-card .ac-icon {
  width: 48px; height: 48px;
  background: rgba(245,158,11,0.1);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}
.analytics-card .ac-content { flex: 1; }
.analytics-card .ac-title {
  font-size: 12px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.analytics-card .ac-value {
  font-size: 20px;
  font-weight: 700;
  font-family: 'Syne', sans-serif;
  color: var(--text);
}
.analytics-card .ac-savings {
  font-size: 11px;
  color: var(--green);
  margin-top: 2px;
}
.analytics-total {
  background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05));
  border: 1px solid var(--amber);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
  margin-bottom: 16px;
}
.analytics-total .at-label {
  font-size: 11px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 4px;
}
.analytics-total .at-value {
  font-size: 28px;
  font-weight: 800;
  font-family: 'Syne', sans-serif;
  color: var(--amber);
}

/* â”€â”€â”€ STATIC PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.static-page {
  position: fixed;
  inset: 52px 0 0 0;
  background: var(--bg);
  z-index: 500;
  overflow-y: auto;
  display: none;
}
.static-page.active { display: block; }
.static-content {
  max-width: 900px;
  margin: 0 auto;
  padding: 40px 20px;
}
.static-content h1 {
  font-family: 'Syne', sans-serif;
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 24px;
  color: var(--text);
}
.static-content h2 {
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 700;
  margin: 32px 0 16px;
  color: var(--amber);
}
.static-content p {
  font-size: 14px;
  line-height: 1.8;
  color: var(--text2);
  margin-bottom: 16px;
}
.static-content ul {
  margin: 16px 0;
  padding-left: 24px;
}
.static-content li {
  font-size: 14px;
  color: var(--text2);
  margin-bottom: 8px;
  line-height: 1.6;
}
.feature-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin: 32px 0;
}
.feature-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  transition: all 0.2s;
}
.feature-card:hover {
  border-color: var(--amber);
  transform: translateY(-2px);
}
.feature-card .fc-icon {
  font-size: 32px;
  margin-bottom: 12px;
}
.feature-card h3 {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text);
}
.feature-card p {
  font-size: 13px;
  color: var(--text2);
  margin: 0;
}

/* â”€â”€â”€ COMPRESSION OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.compress-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}
.compress-option {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}
.compress-option:hover { border-color: var(--border2); }
.compress-option.selected {
  border-color: var(--amber);
  background: rgba(245,158,11,0.05);
}
.compress-option .co-name {
  font-size: 12px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
}
.compress-option .co-desc {
  font-size: 10px;
  color: var(--text3);
}

/* â”€â”€â”€ BOOKLET / SPECIAL MODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mode-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
  background: var(--surface);
  padding: 4px;
  border-radius: 8px;
}
.mode-tab {
  flex: 1;
  padding: 8px 12px;
  background: transparent;
  border: none;
  color: var(--text2);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.15s;
}
.mode-tab:hover { color: var(--text); }
.mode-tab.active {
  background: var(--amber);
  color: #000;
}

/* â”€â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-footer {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 40px 20px;
  text-align: center;
}
.main-footer .footer-links {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.main-footer a {
  color: var(--text2);
  text-decoration: none;
  font-size: 13px;
  transition: color 0.2s;
}
.main-footer a:hover { color: var(--amber); }
.main-footer .copyright {
  font-size: 12px;
  color: var(--text3);
}
</style>
</head>

<body>

<!-- â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="header">
  <div class="logo" onclick="showHome()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
      <rect x="3" y="3" width="18" height="18" rx="3" stroke="var(--amber)" stroke-width="2"/>
      <path d="M7 8h10M7 12h6M7 16h8" stroke="var(--amber)" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    MyLocal<span class="dot">PDF</span>
  </div>
  <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace">v7.0 Â· Client-Side Engine</div>
  <div class="header-sep"></div>
  
  <nav class="nav-links">
    <a href="#" class="nav-link" onclick="showStaticPage('features')">Features</a>
    <a href="#" class="nav-link" onclick="showStaticPage('faq')">FAQ</a>
    <a href="#" class="nav-link" onclick="showStaticPage('contact')">Contact</a>
    <a href="#" class="nav-link" onclick="openAnalyticsModal()">ğŸ“Š My Impact</a>
  </nav>
  
  <div class="badge-local">
    <div class="dot-live"></div>
    LOCAL ONLY
  </div>
  <div class="net-monitor" title="Network requests since page load">
    ğŸ›° NET <span class="count" id="net-count">0</span> REQ
  </div>
  <button class="btn-close" id="close-btn" onclick="closeDocument()" title="Close File &amp; Return Home">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
  </button>
  <button class="btn-tools" id="tools-btn" onclick="openToolsModal()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
    TOOLS
  </button>
</header>

<!-- â”€â”€â”€ AD BANNER (Revenue Stream) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="ad-banner" id="ad-banner">
  <span class="ad-label">AD</span>
  <span>Support MyLocalPDF â€” Upgrade to Pro for unlimited access and no ads</span>
  <button class="btn-pro" onclick="openProModal()">âš¡ GO PRO</button>
  <span class="ad-close" onclick="document.getElementById('ad-banner').style.display='none'">âœ•</span>
</div>

<!-- â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main" id="main-app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span>PAGES</span>
      <span class="page-count-badge" id="page-count-badge">â€”</span>
    </div>
    <div class="page-thumbs" id="page-thumbs"></div>
    <div class="sidebar-footer">
      <div class="usage-bar">
        <div class="usage-label">
          <span>HOURLY BAKES</span>
          <span id="usage-label-count">0 / 3</span>
        </div>
        <div class="usage-track">
          <div class="usage-fill" id="usage-fill" style="width:0%"></div>
        </div>
      </div>
      <div class="usage-bar">
        <div class="usage-label">
          <span>TOOL USES</span>
          <span id="usage-tools-count">0 / 5</span>
        </div>
        <div class="usage-track">
          <div class="usage-fill" id="usage-tools-fill" style="width:0%"></div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:6px" id="limit-reset-label">Resets hourly</div>
      <button onclick="openProModal()" style="width:100%;padding:6px;background:linear-gradient(135deg,var(--amber),#d97706);color:#000;border:none;border-radius:6px;font-weight:700;font-size:11px;font-family:'Syne',sans-serif;cursor:pointer;letter-spacing:0.3px" id="sidebar-pro-btn">âš¡ GO PRO â€” Unlimited</button>
    </div>
  </aside>

  <!-- WORKSPACE -->
  <div class="workspace" id="workspace">

    <!-- FLOATING TOOLBAR -->
    <div class="toolbar" id="toolbar">
      <!-- Undo / Redo -->
      <button class="history-btn" id="undo-btn" onclick="undo()" title="Undo (Ctrl+Z)" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 7v6h6"/><path d="M3 13A9 9 0 1 0 5.7 5.7L3 7"/></svg>
      </button>
      <button class="history-btn" id="redo-btn" onclick="redo()" title="Redo (Ctrl+Y)" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 7v6h-6"/><path d="M21 13A9 9 0 1 1 18.3 5.7L21 7"/></svg>
      </button>
      <div class="tool-sep"></div>
      <button class="tool-btn" id="tool-select" onclick="setTool('select')" title="Select & Move">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l14 9-7 2-4 7-3-18z"/></svg>
        SELECT
      </button>
      <button class="tool-btn" id="tool-text" onclick="setTool('text')" title="Add Text">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
        TEXT
      </button>
      <button class="tool-btn" id="tool-whiteout" onclick="setTool('whiteout')" title="Whiteout / Cover">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6v6H9z" fill="currentColor"/></svg>
        WHITEOUT
      </button>
      <button class="tool-btn" id="tool-highlight" onclick="setTool('highlight')" title="Highlight (yellow)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="7" rx="1" fill="rgba(255,235,59,0.5)"/><path d="M6 11V7M18 11V7" stroke-width="1.5"/></svg>
        HIGHLIGHT
      </button>
      <button class="tool-btn" id="tool-redact" onclick="setTool('redact')" title="Redact (black)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" fill="currentColor" opacity="0.8"/><path d="M9 9l6 6M15 9l-6 6" stroke="#fff" stroke-width="2"/></svg>
        REDACT
      </button>
      <button class="tool-btn" id="tool-image" onclick="triggerImageUpload()" title="Insert Image / Signature">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
        IMAGE
      </button>
      <button class="tool-btn" id="tool-sign" onclick="openSignModal()" title="Draw Signature">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17c3-3 5-5 7-5s3 3 5 3 4-4 6-4M3 17l4-8"/></svg>
        SIGN
      </button>
      <button class="tool-btn" id="tool-form" onclick="detectAndFillForms()" title="Fill Forms">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>
        FORMS
      </button>
      <div class="tool-sep"></div>
      <!-- Text options -->
      <div class="text-options" id="text-options">
        <select id="font-family" onchange="updateTextStyle()">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times</option>
          <option value="Courier New">Courier</option>
          <option value="Georgia">Georgia</option>
        </select>
        <input type="number" id="font-size" value="14" min="6" max="72" onchange="updateTextStyle()" style="width:50px"/>
        <input type="color" id="font-color" value="#000000" onchange="updateTextStyle()" title="Text color"/>
        <!-- V2: Font match indicator -->
        <div class="font-match-badge" id="font-match-badge">
          <span class="fm-icon">ğŸ¯</span>
          <span id="font-match-label">Font matched</span>
        </div>
        <div class="tool-sep"></div>
      </div>
      <!-- Zoom controls -->
      <div class="zoom-bar">
        <button class="zoom-btn" onclick="adjustZoom(-0.25)" title="Zoom Out">âˆ’</button>
        <span class="zoom-level" id="zoom-level">150%</span>
        <button class="zoom-btn" onclick="adjustZoom(+0.25)" title="Zoom In">+</button>
        <button class="zoom-fit" onclick="fitToWidth()" title="Fit to width">FIT</button>
      </div>
      <div class="tool-sep"></div>
      <button class="btn-apply" id="bake-btn" onclick="triggerBake()">
        â–¼ Apply & Download
      </button>
    </div>

    <!-- DROP ZONE (shown when no file) -->
    <div class="dropzone" id="dropzone">
      <div class="drop-card" id="drop-card">
        <span class="drop-icon">ğŸ“„</span>
        <div class="drop-title">Drop your PDF here</div>
        <div class="drop-sub">
          Your file is processed entirely on this laptop.<br/>
          Zero bytes leave your device â€” ever.<br/>
          <span style="color:var(--green);font-size:12px">âœ¦ v7.0: Form Filling, Advanced Compression, Booklet Mode</span>
        </div>
        <button class="btn-open" onclick="document.getElementById('file-input').click()">
          Open Local PDF
        </button>
        <div class="quick-tools-bar">
          <div class="quick-tools-label">QUICK TOOLS</div>
          <div class="quick-tools-row">
            <button class="btn-tools" onclick="openMergeModal()" style="background:var(--surface)">ğŸ”€ Merge PDFs</button>
            <button class="btn-tools" onclick="openImg2PdfModal()" style="background:var(--surface)">ğŸ–¼ï¸ Img â†’ PDF</button>
            <button class="btn-tools" onclick="openCompressModal()" style="background:var(--surface)">ğŸ—œï¸ Compress</button>
          </div>
        </div>
        <br/>
        <div class="privacy-pills">
          <span class="pill">ğŸ”’ ZERO UPLOAD</span>
          <span class="pill">âš¡ WASM ENGINE</span>
          <span class="pill">ğŸ“¶ WORKS OFFLINE</span>
          <span class="pill">ğŸ“ FORM FILLER</span>
          <span class="pill">ğŸ›¡ï¸ META SCRUB</span>
        </div>
      </div>
    </div>

    <!-- CANVAS SCROLL AREA -->
    <div class="canvas-scroll" id="canvas-scroll" style="display:none">
      <div class="page-wrapper" id="page-wrapper">
        <canvas id="pdf-bg-canvas"></canvas>
        <div id="overlay"></div>
      </div>
    </div>

    <!-- LOADING -->
    <div class="loading-overlay" id="loading-overlay" style="display:none">
      <div class="spinner"></div>
      <div class="loading-text" id="loading-text">Scanning PDF for security threatsâ€¦</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    </div>

  </div><!-- /workspace -->
</div><!-- /main -->

<!-- â”€â”€â”€ STATIC PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="static-page" id="page-features">
  <div class="static-content">
    <h1>ğŸ› ï¸ Features</h1>
    <p>MyLocalPDF offers powerful PDF editing tools that run entirely in your browser. No uploads, no waiting, complete privacy.</p>
    
    <div class="feature-grid">
      <div class="feature-card">
        <div class="fc-icon">ğŸ“</div>
        <h3>Form Filling & Auto-Detect</h3>
        <p>Automatically detect fillable form fields. Save your data as templates for reuse. Supports text fields, checkboxes, and dropdowns.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ”€</div>
        <h3>Merge & Split</h3>
        <p>Combine multiple PDFs or extract specific pages. Drag-and-drop interface makes reordering simple.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ—œï¸</div>
        <h3>Advanced Compression</h3>
        <p>Reduce file size with intelligent compression. Choose from Light, Medium, or Aggressive modes. MCA-compliant compression available.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">âœï¸</div>
        <h3>Digital Signature</h3>
        <p>Draw your signature or upload an image. Place anywhere on the document with full control over size and position.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ–Šï¸</div>
        <h3>Text & Annotation</h3>
        <p>Add text boxes, highlights, whiteouts, and redactions. All annotations are editable and resizable.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ“‘</div>
        <h3>Page Organizer</h3>
        <p>Visual drag-and-drop page reordering. Rotate individual pages or delete unwanted pages.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ”¢</div>
        <h3>Bates Numbering</h3>
        <p>Professional sequential numbering for legal documents. Customizable prefix, padding, and position.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ›¡ï¸</div>
        <h3>Metadata Scrubbing</h3>
        <p>Remove author information, creation dates, and software tags. Protect your privacy.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ“–</div>
        <h3>Booklet Creation</h3>
        <p>Format documents for booklet printing. Automatic page arrangement for duplex printing.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ”“</div>
        <h3>PDF Unlock</h3>
        <p>Remove printing and editing restrictions from PDFs (not password-protected files).</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">âš«</div>
        <h3>Black & White</h3>
        <p>Convert color PDFs to grayscale to reduce file size and prepare for printing.</p>
      </div>
      <div class="feature-card">
        <div class="fc-icon">ğŸ”§</div>
        <h3>PDF Repair</h3>
        <p>Fix corrupted PDF files that won't open in standard viewers.</p>
      </div>
    </div>
    
    <h2>Privacy First</h2>
    <p>Unlike online PDF converters, MyLocalPDF processes everything locally in your browser. Your files never leave your device, ensuring complete confidentiality for sensitive documents.</p>
    
    <h2>Pro Features</h2>
    <p>Upgrade to Pro for unlimited access to all tools, no watermarks, and priority processing. One-time payment options available.</p>
  </div>
</div>

<div class="static-page" id="page-faq">
  <div class="static-content">
    <h1>â“ Frequently Asked Questions</h1>
    
    <h2>Is MyLocalPDF really free?</h2>
    <p>Yes! The free tier includes 3 PDF exports per hour and access to basic tools. Upgrade to Pro for unlimited usage and advanced features.</p>
    
    <h2>Are my files uploaded to your servers?</h2>
    <p>Absolutely not. MyLocalPDF runs entirely in your browser using WebAssembly technology. Your PDFs are processed locally and never transmitted over the internet.</p>
    
    <h2>What browsers are supported?</h2>
    <p>MyLocalPDF works best in Chrome, Firefox, Edge, and Safari (latest versions). Internet Explorer is not supported.</p>
    
    <h2>Why is there a file size limit?</h2>
    <p>Browser memory limitations restrict how large a PDF we can process. For best results, keep files under 100MB. Pro users can process larger files.</p>
    
    <h2>Can I use this offline?</h2>
    <p>Yes! After the first visit, MyLocalPDF can work offline. Install it as a PWA (Progressive Web App) for the best offline experience.</p>
    
    <h2>The converted file is larger than the original. Why?</h2>
    <p>This can happen when adding annotations or form data. Use the Compress tool to reduce file size after editing.</p>
    
    <h2>How do I fill forms?</h2>
    <p>Open a PDF with form fields and click the FORMS button in the toolbar, or use Tools > Form Filling. The system will auto-detect fillable fields.</p>
    
    <h2>Can I remove the watermark?</h2>
    <p>Free exports include a small watermark. Upgrade to Pro to remove watermarks permanently.</p>
  </div>
</div>

<div class="static-page" id="page-contact">
  <div class="static-content">
    <h1>ğŸ“§ Contact Us</h1>
    <p>Have questions, feedback, or need support? We'd love to hear from you.</p>
    
    <h2>Support</h2>
    <p>For technical support or bug reports, please include:</p>
    <ul>
      <li>Your browser and version</li>
      <li>Operating system</li>
      <li>Description of the issue</li>
      <li>Steps to reproduce</li>
    </ul>
    
    <h2>Feature Requests</h2>
    <p>Have an idea for a new feature? Let us know! We prioritize features based on user demand.</p>
    
    <h2>Business Inquiries</h2>
    <p>For enterprise licensing, white-label solutions, or partnership opportunities, please reach out.</p>
    
    <h2>Connect</h2>
    <p>Follow us on social media for updates and tips:</p>
    <ul>
      <li>Twitter: @MyLocalPDF</li>
      <li>GitHub: github.com/mylocalpdf</li>
    </ul>
    
    <div style="margin-top: 40px; padding: 24px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border);">
      <h3 style="margin-top: 0; color: var(--amber);">Support MyLocalPDF</h3>
      <p>MyLocalPDF is developed by a small team dedicated to privacy-respecting software. Your support helps us keep the lights on and continue improving the product.</p>
      <button class="btn-pro" onclick="openProModal(); showHome();" style="margin-top: 12px;">âš¡ Upgrade to Pro</button>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <span id="sb-file">No file loaded</span>
  <div class="sep"></div>
  <span id="sb-pages">â€”</span>
  <div class="sep"></div>
  <span id="sb-tool">TOOL: SELECT</span>
  <div class="sep"></div>
  <span id="sb-ann">0 annotations</span>
  <div class="sep"></div>
  <span id="sb-tier" class="warn">FREE TIER</span>
  <div class="header-sep" style="flex:1"></div>
  <span id="sb-mem" class="highlight" style="font-family:'JetBrains Mono',monospace;font-size:10px">HEAP: â€”</span>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<!-- HIDDEN INPUTS -->
<input type="file" id="file-input" accept=".pdf" style="display:none" onchange="handleFileInput(this)"/>
<input type="file" id="image-input" accept="image/png, image/jpeg, image/jpg" style="display:none" onchange="handleImageInput(this)"/>
<input type="file" id="merge-input" accept=".pdf" multiple style="display:none" onchange="handleMergeInput(this)"/>
<input type="file" id="img2pdf-input" accept="image/png, image/jpeg, image/jpg" multiple style="display:none" onchange="handleImg2PdfInput(this)"/>

<!-- â”€â”€â”€ PRO MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="pro-modal" style="display:none">
  <div class="modal" style="max-width:520px">
    <h2>âš¡ MyLocalPDF Pro</h2>
    <p style="margin-bottom:14px">100% local processing â€” no account, no cloud, no tracking. Pay once, get a key instantly.</p>

    <!-- Feature grid -->
    <div class="pro-features" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:14px">
      <div class="pro-feat"><span class="icon">âˆ</span> Unlimited bakes</div>
      <div class="pro-feat"><span class="icon">ğŸ“„</span> 500+ page PDFs</div>
      <div class="pro-feat"><span class="icon">ğŸ’§</span> No watermark</div>
      <div class="pro-feat"><span class="icon">ğŸ”¢</span> Bates Numbering</div>
      <div class="pro-feat"><span class="icon">ğŸ›¡ï¸</span> Metadata Scrub</div>
      <div class="pro-feat"><span class="icon">ğŸ”</span> Password Protect</div>
      <div class="pro-feat"><span class="icon">ğŸ’§</span> Custom Watermark</div>
      <div class="pro-feat"><span class="icon">ğŸ—œï¸</span> PDF Compress</div>
      <div class="pro-feat"><span class="icon">ğŸ”€</span> Unlimited Merge</div>
      <div class="pro-feat"><span class="icon">âœ‚ï¸</span> Unlimited Split</div>
      <div class="pro-feat"><span class="icon">ğŸ“‘</span> Header & Footer</div>
      <div class="pro-feat"><span class="icon">âš¡</span> Priority export</div>
    </div>

    <!-- Payment options -->
    <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:8px;letter-spacing:0.5px">CHOOSE PLAN â€” PAY ONCE, KEY EMAILED INSTANTLY</div>
    <div class="pay-methods">
      <div class="pay-btn" onclick="openPayLink('monthly')">
        <span class="pay-icon">ğŸ“…</span>
        <span class="pay-price">$4.99</span>
        <span class="pay-label">PER MONTH</span>
      </div>
      <div class="pay-btn" onclick="openPayLink('yearly')">
        <span class="pay-icon">ğŸ†</span>
        <span class="pay-price">$29.99</span>
        <span class="pay-label">PER YEAR Â· SAVE 50%</span>
      </div>
      <div class="pay-btn" onclick="openPayLink('lifetime')">
        <span class="pay-icon">â™¾ï¸</span>
        <span class="pay-price">$49.99</span>
        <span class="pay-label">LIFETIME</span>
      </div>
    </div>

    <!-- Key entry -->
    <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:6px;letter-spacing:0.5px">ALREADY HAVE A KEY?</div>
    <input type="text" id="license-input" placeholder="PRO-XXXXX-XXXXX-XXXXX" autocomplete="off" style="margin-bottom:6px"/>
    <p style="font-size:11px;color:var(--text3);margin-bottom:16px">
      No signup required Â· Key verified locally Â· Demo key: <code style="color:var(--amber);font-family:'JetBrains Mono'">PRO-DEMO-MYPDF-2025</code>
    </p>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('pro-modal')">Maybe Later</button>
      <button class="btn-confirm" onclick="activateLicense()">Verify Key â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SIGNATURE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="sign-modal" style="display:none">
  <div class="modal">
    <h2>âœ’ï¸ Draw Your Signature</h2>
    <p>Draw below. Your signature stays on this device and is converted to a transparent PNG.</p>
    <canvas id="sign-canvas" width="416" height="150"
      style="background:#fff;border:1px solid var(--border2);border-radius:8px;cursor:crosshair;display:block;touch-action:none;margin-bottom:12px;width:100%">
    </canvas>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="clearSignature()">Clear</button>
      <button class="btn-cancel" onclick="closeModal('sign-modal')">Cancel</button>
      <button class="btn-confirm" onclick="placeSignature()">Place Signature</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ UPGRADE PROMPT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="upgrade-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ”’ Limit Reached</h2>
    <p id="upgrade-msg">You've reached your hourly limit. Upgrade to Pro for unlimited usage with no restrictions.</p>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace;line-height:1.7">
      <div>âœ… No account or signup required</div>
      <div>âœ… Key delivered instantly after payment</div>
      <div>âœ… Works 100% offline â€” no phone home</div>
      <div>âœ… One-time purchase options available</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('upgrade-modal')">Maybe Later</button>
      <button class="btn-confirm" onclick="closeModal('upgrade-modal');openProModal()">See Pro Plans â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ TOOLS HUB MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="tools-modal" style="display:none">
  <div class="modal" style="max-width:560px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <h2>ğŸ› ï¸ Tool Hub</h2>
      <span style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace" id="tools-tier-label">FREE TIER</span>
    </div>
    <p style="margin-bottom:12px">All processing happens on your device. Zero uploads, ever.</p>

    <!-- Hourly usage meters -->
    <div class="limit-meters" id="limit-meters-block">
      <div class="limit-row">
        <span class="limit-row-label">BAKES</span>
        <div class="limit-track"><div class="limit-fill" id="lm-bake" style="width:0%"></div></div>
        <span class="limit-count" id="lm-bake-txt">0/3</span>
      </div>
      <div class="limit-row">
        <span class="limit-row-label">TOOLS</span>
        <div class="limit-track"><div class="limit-fill" id="lm-tool" style="width:0%"></div></div>
        <span class="limit-count" id="lm-tool-txt">0/5</span>
      </div>
    </div>

    <div class="tools-grid" style="grid-template-columns:1fr 1fr 1fr">

      <!-- Row 1: Document ops -->
      <button class="tool-card" onclick="closeModal('tools-modal');openMergeModal()">
        <span class="tc-icon">ğŸ”€</span>
        <div class="tc-title">Merge PDFs</div>
        <div class="tc-desc">Combine multiple PDFs into one.</div>
        <span class="tc-limit limited" id="tlimit-merge">3 files / hr</span>
      </button>
      <button class="tool-card" onclick="closeModal('tools-modal');openSplitModal()">
        <span class="tc-icon">âœ‚ï¸</span>
        <div class="tc-title">Split / Extract</div>
        <div class="tc-desc">Extract pages into new PDF.</div>
        <span class="tc-limit limited" id="tlimit-split">2 / hr</span>
      </button>
      <button class="tool-card" onclick="closeModal('tools-modal');openPageOrgModal()">
        <span class="tc-icon">ğŸ“‘</span>
        <div class="tc-title">Page Organiser</div>
        <div class="tc-desc">Drag, rotate & delete pages.</div>
        <span class="tc-limit free">UNLIMITED</span>
      </button>

      <!-- Row 2: Content tools -->
      <button class="tool-card" onclick="closeModal('tools-modal');openImg2PdfModal()">
        <span class="tc-icon">ğŸ–¼ï¸</span>
        <div class="tc-title">Images â†’ PDF</div>
        <div class="tc-desc">JPG/PNG images to PDF.</div>
        <span class="tc-limit limited" id="tlimit-img2pdf">5 imgs / hr</span>
      </button>
      <button class="tool-card" onclick="closeModal('tools-modal');openWatermarkModal()">
        <span class="tc-icon">ğŸ’§</span>
        <div class="tc-title">Watermark</div>
        <div class="tc-desc">Stamp diagonal text watermark.</div>
        <span class="tc-limit limited" id="tlimit-wm">2 / hr</span>
      </button>
      <button class="tool-card" onclick="closeModal('tools-modal');openPageNumModal()">
        <span class="tc-icon">ğŸ“„</span>
        <div class="tc-title">Page Numbers</div>
        <div class="tc-desc">Add header or footer numbering.</div>
        <span class="tc-limit limited" id="tlimit-pgnum">2 / hr</span>
      </button>

      <!-- Row 3: Pro tools -->
      <button class="tool-card" onclick="closeModal('tools-modal');openBatesModal()">
        <span class="tc-icon">ğŸ”¢</span>
        <div class="tc-title">Bates Numbering</div>
        <div class="tc-desc">Legal sequential page labels.</div>
        <span class="pro-badge">PRO</span>
      </button>
      <button class="tool-card pro-card" onclick="closeModal('tools-modal');openPasswordModal()">
        <span class="tc-icon">ğŸ”</span>
        <div class="tc-title">Password Protect</div>
        <div class="tc-desc">Encrypt PDF with a password.</div>
        <span class="pro-badge">PRO</span>
      </button>
      <button class="tool-card pro-card" onclick="closeModal('tools-modal');openCompressModal()">
        <span class="tc-icon">ğŸ—œï¸</span>
        <div class="tc-title">Compress PDF</div>
        <div class="tc-desc">Reduce file size for sharing.</div>
        <span class="pro-badge">PRO</span>
      </button>

      <!-- Row 4: Privacy -->
      <button class="tool-card pro-card" onclick="closeModal('tools-modal');runMetaScrub()">
        <span class="tc-icon">ğŸ›¡ï¸</span>
        <div class="tc-title">Scrub Metadata</div>
        <div class="tc-desc">Strip author, dates & tags.</div>
        <span class="pro-badge">PRO</span>
      </button>
      <button class="tool-card" onclick="closeModal('tools-modal');openHeaderFooterModal()">
        <span class="tc-icon">ğŸ“‹</span>
        <div class="tc-title">Header & Footer</div>
        <div class="tc-desc">Add custom text to all pages.</div>
        <span class="tc-limit limited" id="tlimit-hf">2 / hr</span>
      </button>
      <button class="tool-card" onclick="closeModal('tools-modal');openFlattenModal()">
        <span class="tc-icon">ğŸ§±</span>
        <div class="tc-title">Flatten PDF</div>
        <div class="tc-desc">Lock annotations & forms.</div>
        <span class="tc-limit limited" id="tlimit-flatten">2 / hr</span>
      </button>

      <!-- Row 5: NEW FEATURES -->
      <button class="tool-card" onclick="closeModal('tools-modal');detectAndFillForms()">
        <span class="tc-icon">ğŸ“</span>
        <div class="tc-title">Form Filling</div>
        <div class="tc-desc">Auto-detect & fill PDF forms.</div>
        <span class="tc-limit limited">3 forms / day</span>
      </button>
      <button class="tool-card pro-card" onclick="closeModal('tools-modal');openBookletModal()">
        <span class="tc-icon">ğŸ“–</span>
        <div class="tc-title">Booklet Mode</div>
        <div class="tc-desc">Format for booklet printing.</div>
        <span class="pro-badge">PRO</span>
      </button>
      <button class="tool-card pro-card" onclick="closeModal('tools-modal');openRepairModal()">
        <span class="tc-icon">ğŸ”§</span>
        <div class="tc-title">Repair PDF</div>
        <div class="tc-desc">Fix corrupted PDF files.</div>
        <span class="pro-badge">PRO</span>
      </button>

    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('tools-modal')">Close</button>
      <button class="btn-confirm" style="background:var(--blue);border-color:var(--blue)" onclick="closeModal('tools-modal');openProModal()">âš¡ Unlock All Pro Tools</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ MERGE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="merge-modal" style="display:none">
  <div class="modal wide">
    <h2>ğŸ”€ Merge PDFs</h2>
    <p>Add PDF files below. Drag rows to reorder, then click Merge.</p>
    <div class="merge-drop-area" onclick="document.getElementById('merge-input').click()"
         ondragover="event.preventDefault()" ondrop="handleMergeDrop(event)">
      <div style="font-size:28px;margin-bottom:8px">ğŸ“‚</div>
      <div style="font-size:13px;color:var(--text2)">Click to add PDFs or drag &amp; drop here</div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">Multiple files supported</div>
    </div>
    <div class="merge-file-list" id="merge-file-list"></div>
    <div id="merge-status" style="font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:10px;min-height:16px"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('merge-modal');clearMerge()">Cancel</button>
      <button class="btn-confirm" id="merge-run-btn" onclick="runMerge()" disabled>Merge &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SPLIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="split-modal" style="display:none">
  <div class="modal wide">
    <h2>âœ‚ï¸ Split / Extract Pages</h2>
    <p id="split-desc">Select the pages you want to extract into a new PDF.</p>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
      <button class="btn-cancel" style="font-size:11px;padding:4px 10px" onclick="splitSelectAll()">Select All</button>
      <button class="btn-cancel" style="font-size:11px;padding:4px 10px" onclick="splitSelectNone()">Clear</button>
      <button class="btn-cancel" style="font-size:11px;padding:4px 10px" onclick="splitSelectOdd()">Odd</button>
      <button class="btn-cancel" style="font-size:11px;padding:4px 10px" onclick="splitSelectEven()">Even</button>
    </div>
    <div class="split-preview" id="split-preview"></div>
    <div id="split-status" style="font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:10px;min-height:16px"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('split-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runSplit()">Extract Selected</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ BATES NUMBERING MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="bates-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ”¢ Bates Numbering</h2>
    <p>Stamp sequential labels on every page of the current PDF.</p>
    <div class="bates-row">
      <div class="bates-field">
        <label>Prefix</label>
        <input type="text" id="bates-prefix" value="EXHIBIT-" oninput="updateBatesPreview()"/>
      </div>
      <div class="bates-field">
        <label>Start Number</label>
        <input type="number" id="bates-start" value="1" min="0" oninput="updateBatesPreview()"/>
      </div>
      <div class="bates-field">
        <label>Padding (digits)</label>
        <input type="number" id="bates-pad" value="4" min="1" max="10" oninput="updateBatesPreview()"/>
      </div>
      <div class="bates-field">
        <label>Position</label>
        <select id="bates-pos" onchange="updateBatesPreview()">
          <option value="br">Bottom Right</option>
          <option value="bl">Bottom Left</option>
          <option value="bc">Bottom Center</option>
          <option value="tr">Top Right</option>
          <option value="tl">Top Left</option>
        </select>
      </div>
    </div>
    <div style="font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Preview</div>
    <div class="bates-preview" id="bates-preview">EXHIBIT-0001</div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('bates-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runBates()">Apply &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ IMAGE â†’ PDF MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="img2pdf-modal" style="display:none">
  <div class="modal wide">
    <h2>ğŸ–¼ï¸ Images â†’ PDF</h2>
    <p>Add JPG/PNG images. Each image becomes one page. Drag to reorder.</p>
    <div class="merge-drop-area" onclick="document.getElementById('img2pdf-input').click()"
         ondragover="event.preventDefault()" ondrop="handleImg2PdfDrop(event)">
      <div style="font-size:28px;margin-bottom:8px">ğŸï¸</div>
      <div style="font-size:13px;color:var(--text2)">Click to add images or drag &amp; drop</div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">JPG and PNG only</div>
    </div>
    <div class="img2pdf-list" id="img2pdf-list"></div>
    <div id="img2pdf-status" style="font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-bottom:10px;min-height:16px"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('img2pdf-modal');clearImg2Pdf()">Cancel</button>
      <button class="btn-confirm" id="img2pdf-run-btn" onclick="runImg2Pdf()" disabled>Convert &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ PAGE ORDER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="pageorg-modal" style="display:none">
  <div class="modal wide" style="max-width:820px;width:95%">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <h2>ğŸ“‘ Page Organiser</h2>
      <div style="font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace">Drag to reorder Â· â†» rotate Â· Ã— delete</div>
    </div>
    <p style="margin-bottom:12px">Rearrange pages visually, then click Apply Changes to commit.</p>
    <div class="org-grid-container" id="org-grid"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('pageorg-modal')">Cancel</button>
      <button class="btn-confirm" onclick="applyOrganiserChanges()">Apply Changes</button>
    </div>
  </div>
</div>


<!-- â”€â”€â”€ WATERMARK MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="watermark-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ’§ Watermark</h2>
    <p>Stamp diagonal text across every page of the PDF.</p>
    <div class="bates-row">
      <div class="bates-field" style="grid-column:span 2">
        <label>Watermark Text</label>
        <input type="text" id="wm-text" value="CONFIDENTIAL" oninput="updateWmPreview()"/>
      </div>
      <div class="bates-field">
        <label>Opacity (%)</label>
        <input type="number" id="wm-opacity" value="15" min="5" max="60" oninput="updateWmPreview()"/>
      </div>
      <div class="bates-field">
        <label>Font Size (pt)</label>
        <input type="number" id="wm-size" value="48" min="12" max="120" oninput="updateWmPreview()"/>
      </div>
      <div class="bates-field">
        <label>Color</label>
        <select id="wm-color" onchange="updateWmPreview()">
          <option value="0,0,0">Black</option>
          <option value="0.5,0,0">Dark Red</option>
          <option value="0,0,0.5">Dark Blue</option>
          <option value="0.3,0.3,0.3">Grey</option>
        </select>
      </div>
      <div class="bates-field">
        <label>Position</label>
        <select id="wm-pos" onchange="updateWmPreview()">
          <option value="center">Center Diagonal</option>
          <option value="tile">Tiled</option>
          <option value="top">Top Center</option>
          <option value="bottom">Bottom Center</option>
        </select>
      </div>
    </div>
    <div class="wm-preview-box">
      <span class="wm-preview-text" id="wm-preview-text">CONFIDENTIAL</span>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('watermark-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runWatermark()">Apply &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ PASSWORD PROTECT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="password-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ” Password Protect <span class="pro-badge" style="position:relative;top:0;right:0;margin-left:8px">PRO</span></h2>
    <p>Encrypt the PDF so it requires a password to open. Your password never leaves this device.</p>
    <div class="bates-field" style="margin-bottom:10px">
      <label>User Password (required to open)</label>
      <input type="password" id="pw-user" placeholder="Enter open password"/>
    </div>
    <div class="bates-field" style="margin-bottom:10px">
      <label>Owner Password (optional â€” restricts editing)</label>
      <input type="password" id="pw-owner" placeholder="Enter owner/edit password"/>
    </div>
    <div class="bates-field" style="margin-bottom:16px">
      <label>Permissions</label>
      <select id="pw-perms">
        <option value="all">Allow all (print, copy, edit)</option>
        <option value="print">Print only</option>
        <option value="readonly">View only (no print, no copy)</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('password-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runPasswordProtect()">Encrypt &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ COMPRESS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="compress-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ—œï¸ Compress PDF <span class="pro-badge" style="position:relative;top:0;right:0;margin-left:8px">PRO</span></h2>
    <p>Optimize and flatten PDF objects to reduce file size. Works best on PDFs with many images or redundant streams.</p>
    
    <div class="compress-options">
      <div class="compress-option selected" onclick="selectCompressLevel(this, 'light')" id="comp-light">
        <div class="co-name">Light</div>
        <div class="co-desc">Preserve quality</div>
      </div>
      <div class="compress-option" onclick="selectCompressLevel(this, 'medium')" id="comp-medium">
        <div class="co-name">Medium</div>
        <div class="co-desc">Balanced</div>
      </div>
      <div class="compress-option" onclick="selectCompressLevel(this, 'aggressive')" id="comp-aggressive">
        <div class="co-name">Aggressive</div>
        <div class="co-desc">Max compression</div>
      </div>
      <div class="compress-option" onclick="selectCompressLevel(this, 'mca')" id="comp-mca">
        <div class="co-name">MCA Mode</div>
        <div class="co-desc">&lt;2MB target</div>
      </div>
    </div>
    
    <div id="compress-status" style="font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace;min-height:16px;margin-bottom:12px"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('compress-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runCompress()">Compress &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ PAGE NUMBERS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="pagenum-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ“„ Page Numbers</h2>
    <p>Add formatted page numbers to every page of the PDF.</p>
    <div class="bates-row">
      <div class="bates-field">
        <label>Format</label>
        <select id="pgnum-format">
          <option value="n">1, 2, 3â€¦</option>
          <option value="of">1 of 10â€¦</option>
          <option value="dash">â€” 1 â€”</option>
          <option value="page">Page 1</option>
        </select>
      </div>
      <div class="bates-field">
        <label>Position</label>
        <select id="pgnum-pos">
          <option value="bc">Bottom Center</option>
          <option value="br">Bottom Right</option>
          <option value="bl">Bottom Left</option>
          <option value="tc">Top Center</option>
          <option value="tr">Top Right</option>
          <option value="tl">Top Left</option>
        </select>
      </div>
      <div class="bates-field">
        <label>Start At</label>
        <input type="number" id="pgnum-start" value="1" min="0"/>
      </div>
      <div class="bates-field">
        <label>Font Size</label>
        <input type="number" id="pgnum-size" value="10" min="6" max="24"/>
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('pagenum-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runPageNumbers()">Apply &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ HEADER / FOOTER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="headerfooter-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ“‹ Header &amp; Footer</h2>
    <p>Add custom text to the top and/or bottom of every page.</p>
    <div class="bates-field" style="margin-bottom:10px">
      <label>Header Text (leave blank to skip)</label>
      <input type="text" id="hf-header" placeholder="e.g. Company Confidential"/>
    </div>
    <div class="bates-field" style="margin-bottom:10px">
      <label>Footer Text (leave blank to skip)</label>
      <input type="text" id="hf-footer" placeholder="e.g. Â© 2025 Acme Corp"/>
    </div>
    <div class="bates-row">
      <div class="bates-field">
        <label>Font Size</label>
        <input type="number" id="hf-size" value="9" min="6" max="18"/>
      </div>
      <div class="bates-field">
        <label>Alignment</label>
        <select id="hf-align">
          <option value="left">Left</option>
          <option value="center" selected>Center</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('headerfooter-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runHeaderFooter()">Apply &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ FLATTEN MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="flatten-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ§± Flatten PDF</h2>
    <p>Merge all form fields and annotations permanently into the page content. The output is a non-editable, static PDF.</p>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace;line-height:1.7">
      <div>âš ï¸  Flattening is irreversible</div>
      <div>âœ… Removes form field interactivity</div>
      <div>âœ… Locks annotations to page</div>
      <div>âœ… Prevents further editing in external tools</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('flatten-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runFlatten()">Flatten &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ FORM FILLING MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="formfill-modal" style="display:none">
  <div class="modal wide" style="max-width:600px">
    <h2>ğŸ“ Form Filling</h2>
    <p id="form-detect-status">Detecting form fields...</p>
    
    <div class="saved-data-grid" id="saved-data-grid">
      <!-- Saved data templates appear here -->
    </div>
    
    <div class="form-field-list" id="form-field-list">
      <!-- Form fields appear here -->
    </div>
    
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('formfill-modal')">Cancel</button>
      <button class="btn-cancel" onclick="saveFormTemplate()">ğŸ’¾ Save Template</button>
      <button class="btn-confirm" onclick="applyFormFilling()">Fill &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ USAGE ANALYTICS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="analytics-modal" style="display:none">
  <div class="modal" style="max-width:480px">
    <h2>ğŸ“Š Your Impact This Month</h2>
    <p>See how much you've saved by using MyLocalPDF instead of expensive alternatives.</p>
    
    <div class="analytics-total">
      <div class="at-label">Total Value Saved</div>
      <div class="at-value" id="analytics-total-value">$0</div>
    </div>
    
    <div class="analytics-grid">
      <div class="analytics-card">
        <div class="ac-icon">ğŸ”€</div>
        <div class="ac-content">
          <div class="ac-title">PDFs Merged</div>
          <div class="ac-value" id="analytics-merged">0</div>
          <div class="ac-savings" id="analytics-merged-savings">Saved $0 vs Acrobat</div>
        </div>
      </div>
      <div class="analytics-card">
        <div class="ac-icon">ğŸ“</div>
        <div class="ac-content">
          <div class="ac-title">Forms Filled</div>
          <div class="ac-value" id="analytics-forms">0</div>
          <div class="ac-savings" id="analytics-forms-savings">Saved 0 hrs vs manual</div>
        </div>
      </div>
      <div class="analytics-card">
        <div class="ac-icon">ğŸ—œï¸</div>
        <div class="ac-content">
          <div class="ac-title">Storage Saved</div>
          <div class="ac-value" id="analytics-compressed">0 MB</div>
          <div class="ac-savings" id="analytics-compressed-savings">Saved $0 vs cloud storage</div>
        </div>
      </div>
    </div>
    
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;text-align:center">
      <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Pro Cost</div>
      <div style="font-size:18px;font-weight:700;color:var(--text)">$3/month</div>
      <div style="font-size:11px;color:var(--green);margin-top:4px">ROI: <span id="analytics-roi">0x</span> return on investment</div>
    </div>
    
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('analytics-modal')">Close</button>
      <button class="btn-confirm" onclick="closeModal('analytics-modal');openProModal()">Upgrade to Pro</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ BOOKLET MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="booklet-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ“– Booklet Creation <span class="pro-badge" style="position:relative;top:0;right:0;margin-left:8px">PRO</span></h2>
    <p>Format your PDF for booklet printing. Pages are reordered for correct duplex printing.</p>
    <div class="bates-field" style="margin-bottom:16px">
      <label>Page Order</label>
      <select id="booklet-order">
        <option value="booklet">Standard Booklet (2-up)</option>
        <option value="calendar">Calendar Style</option>
      </select>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace;line-height:1.7">
      <div>ğŸ“„ Input: Standard page order (1, 2, 3, 4...)</div>
      <div>ğŸ“– Output: Booklet order (4, 1, 2, 3...)</div>
      <div>ğŸ–¨ï¸ Print: Duplex, short-edge binding</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('booklet-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runBooklet()">Create Booklet</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ REPAIR MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="repair-modal" style="display:none">
  <div class="modal">
    <h2>ğŸ”§ Repair PDF <span class="pro-badge" style="position:relative;top:0;right:0;margin-left:8px">PRO</span></h2>
    <p>Attempt to repair a corrupted PDF file. This will try to recover as much content as possible.</p>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace;line-height:1.7">
      <div>ğŸ” Scans for recoverable objects</div>
      <div>ğŸ“ Rebuilds page structure</div>
      <div>âš ï¸ Some content may be lost</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('repair-modal')">Cancel</button>
      <button class="btn-confirm" onclick="runRepair()">Repair &amp; Download</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SCRIPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const State = {
  pdfDoc: null,
  pageCount: 0,
  currentPage: 1,
  originalBuffer: null,
  viewport: null,
  page: null,
  zoom: 1.5,
  tool: 'select',
  annotations: [],
  assetStore: new Map(),
  isPro: false,
  annIdCounter: 0,
  isDragging: false,
  dragTarget: null,
  dragOffX: 0, dragOffY: 0,
  isDrawingRect: false,
  rectStartX: 0, rectStartY: 0,
  currentRectEl: null,
  sigDrawing: false,
  sigPts: [],
  pageMap: [],
  pageRotations: {},
  undoStack: [],
  redoStack: [],
  compressLevel: 'light',
  detectedFormFields: [],
  savedFormData: {},
};

// â”€â”€â”€ LICENSE VERIFICATION â€” Web Crypto API (RSA-PKCS1-v1_5 / SHA-256) â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PUBLIC_KEY_PEM = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2a2rwplBQLF29amygykE
MmYz0+Kcj3bKBp29Mi3o8xHFCVhKDK9yBBqZBLs25mAiCqXQEJGBhHkwGCIxVNMc
PLACEHOLDER_REPLACE_WITH_YOUR_REAL_OPENSSL_PUBLIC_KEY_PEM_CONTENT
-----END PUBLIC KEY-----`;

const DEMO_PRO_TOKEN = 'PRO-DEMO-MYPDF-2025';
const IS_PLACEHOLDER_KEY = PUBLIC_KEY_PEM.includes('PLACEHOLDER_REPLACE');

async function importPublicKey() {
  if (IS_PLACEHOLDER_KEY) return null;
  try {
    const pemBody = PUBLIC_KEY_PEM
      .replace(/-----BEGIN PUBLIC KEY-----|-----END PUBLIC KEY-----|\n|\r/g, '');
    const binaryDer = Uint8Array.from(atob(pemBody), c => c.charCodeAt(0));
    return await window.crypto.subtle.importKey(
      'spki',
      binaryDer.buffer,
      { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
      true,
      ['verify']
    );
  } catch (e) {
    console.warn('Public key import failed:', e.message);
    return null;
  }
}

async function verifyJWT(token) {
  const parts = token.split('.');
  if (parts.length !== 3) return false;
  const [headerB64, payloadB64, sigB64] = parts;

  try {
    const payload = JSON.parse(atob(payloadB64.replace(/-/g, '+').replace(/_/g, '/')));
    if (payload.exp && Date.now() / 1000 > payload.exp) {
      toast('License key has expired. Please renew.', 'error');
      return false;
    }
    if (payload.tier !== 'pro') return false;

    const pubKey = await importPublicKey();
    if (!pubKey) return false;

    const data = new TextEncoder().encode(headerB64 + '.' + payloadB64);
    const sigBase64 = sigB64.replace(/-/g, '+').replace(/_/g, '/');
    const signature = Uint8Array.from(atob(sigBase64), c => c.charCodeAt(0));

    return await window.crypto.subtle.verify('RSASSA-PKCS1-v1_5', pubKey, signature, data);
  } catch (e) {
    console.error('JWT verify error:', e);
    return false;
  }
}

async function checkProKey() {
  try {
    const k = localStorage.getItem('mypdf_pro_key');
    if (!k) return;
    if (IS_PLACEHOLDER_KEY && k === DEMO_PRO_TOKEN) {
      State.isPro = true; return;
    }
    const valid = await verifyJWT(k);
    if (valid) State.isPro = true;
    else {
      localStorage.removeItem('mypdf_pro_key');
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOURLY LIMIT SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LIMITS = {
  bake:    { free: 3,  label: 'bakes/hr',    maxPages: 10 },
  merge:   { free: 2,  label: 'merges/hr',   maxFiles: 3 },
  split:   { free: 2,  label: 'splits/hr' },
  img2pdf: { free: 2,  label: 'converts/hr', maxImages: 5 },
  watermark:{ free: 2, label: 'stamps/hr' },
  pagenum: { free: 2,  label: 'uses/hr' },
  hf:      { free: 2,  label: 'uses/hr' },
  flatten: { free: 2,  label: 'uses/hr' },
  formfill:{ free: 3,  label: 'forms/day' },
  tools:   { free: 5,  label: 'tool uses/hr' },
};

function getHourKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}-${d.getHours()}`;
}

function getDayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
}

function getUsage() {
  try {
    const raw = localStorage.getItem('mypdf_usage_v2') || '{}';
    const u = JSON.parse(raw);
    if (u.hourKey !== getHourKey()) {
      return { hourKey: getHourKey(), dayKey: getDayKey(), bake: 0, tools: 0, formfill: 0 };
    }
    if (u.dayKey !== getDayKey()) {
      u.dayKey = getDayKey();
      u.formfill = 0;
    }
    return u;
  } catch { return { hourKey: getHourKey(), dayKey: getDayKey(), bake: 0, tools: 0, formfill: 0 }; }
}

function saveUsage(u) {
  try { localStorage.setItem('mypdf_usage_v2', JSON.stringify(u)); } catch {}
}

function checkLimit(type) {
  if (State.isPro) return true;
  const u = getUsage();
  if (type === 'formfill') {
    return (u.formfill || 0) < LIMITS.formfill.free;
  }
  const bucket = type === 'bake' ? 'bake' : 'tools';
  const limit = type === 'bake' ? LIMITS.bake.free : LIMITS.tools.free;
  return (u[bucket] || 0) < limit;
}

function consumeLimit(type) {
  if (State.isPro) return;
  const u = getUsage();
  if (type === 'formfill') {
    u.formfill = (u.formfill || 0) + 1;
  } else {
    const bucket = type === 'bake' ? 'bake' : 'tools';
    u[bucket] = (u[bucket] || 0) + 1;
  }
  saveUsage(u);
  updateStatusBar();
}

function showLimitModal(msg) {
  document.getElementById('upgrade-msg').textContent = msg;
  document.getElementById('upgrade-modal').style.display = 'flex';
}

function minutesUntilReset() {
  const now = new Date();
  return 60 - now.getMinutes();
}

function openPayLink(plan) {
  const links = {
    monthly:  'https://buy.stripe.com/your-monthly-link',
    yearly:   'https://buy.stripe.com/your-yearly-link',
    lifetime: 'https://buy.stripe.com/your-lifetime-link',
  };
  toast('Opening payment pageâ€¦ (configure your payment links in the source)', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toast(msg, type='info') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = {info:'ğŸ’¡', success:'âœ…', error:'âŒ'};
  t.innerHTML = `<span>${icons[type]||'â€¢'}</span> ${msg}`;
  c.appendChild(t);
  setTimeout(() => { if (t.parentNode) t.remove(); }, 3000);
}

function openProModal() {
  document.getElementById('pro-modal').style.display = 'flex';
}
function openSignModal() {
  document.getElementById('sign-modal').style.display = 'flex';
  setTimeout(() => initSignatureCanvas(), 50);
}
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

function setLoading(show, msg='Processingâ€¦', progress=0) {
  const el = document.getElementById('loading-overlay');
  el.style.display = show ? 'flex' : 'none';
  document.getElementById('loading-text').textContent = msg;
  document.getElementById('progress-fill').style.width = progress + '%';
}

function updateStatusBar() {
  const u = getUsage();
  const tierEl = document.getElementById('sb-tier');
  tierEl.textContent = State.isPro ? 'PRO âˆ' : 'FREE TIER';
  tierEl.className = State.isPro ? 'highlight' : 'warn';
  document.getElementById('sb-ann').textContent = State.annotations.length + ' annotations';
  document.getElementById('sb-tool').textContent = 'TOOL: ' + State.tool.toUpperCase();

  const bakeCount = u.bake || 0;
  const toolCount = u.tools || 0;

  if (State.isPro) {
    document.getElementById('usage-fill').style.width = '0%';
    document.getElementById('usage-label-count').textContent = 'âˆ';
    const tf = document.getElementById('usage-tools-fill');
    if (tf) { tf.style.width = '0%'; document.getElementById('usage-tools-count').textContent = 'âˆ'; }
    const rl = document.getElementById('limit-reset-label');
    if (rl) rl.textContent = 'Pro â€” unlimited';
    const sidebarBtn = document.getElementById('sidebar-pro-btn');
    if (sidebarBtn) { sidebarBtn.textContent = 'âœ“ PRO ACTIVE'; sidebarBtn.style.background = 'var(--green)'; }
    const adBanner = document.getElementById('ad-banner');
    if (adBanner) adBanner.style.display = 'none';
  } else {
    const bPct = Math.min(100, (bakeCount / LIMITS.bake.free) * 100);
    const tPct = Math.min(100, (toolCount / LIMITS.tools.free) * 100);
    document.getElementById('usage-fill').style.width = bPct + '%';
    document.getElementById('usage-label-count').textContent = `${bakeCount} / ${LIMITS.bake.free}`;
    const tf = document.getElementById('usage-tools-fill');
    if (tf) { tf.style.width = tPct + '%'; document.getElementById('usage-tools-count').textContent = `${toolCount} / ${LIMITS.tools.free}`; }
    const rl = document.getElementById('limit-reset-label');
    if (rl) rl.textContent = `Resets in ~${minutesUntilReset()}min`;
  }

  const lmBake = document.getElementById('lm-bake');
  if (lmBake) {
    const bp = State.isPro ? 0 : Math.min(100,(bakeCount/LIMITS.bake.free)*100);
    const tp = State.isPro ? 0 : Math.min(100,(toolCount/LIMITS.tools.free)*100);
    lmBake.style.width = bp + '%';
    document.getElementById('lm-bake-txt').textContent = State.isPro ? 'âˆ' : `${bakeCount}/${LIMITS.bake.free}`;
    document.getElementById('lm-tool').style.width = tp + '%';
    document.getElementById('lm-tool-txt').textContent = State.isPro ? 'âˆ' : `${toolCount}/${LIMITS.tools.free}`;
    document.getElementById('tools-tier-label').textContent = State.isPro ? 'âš¡ PRO ACTIVE' : 'FREE TIER';
    const lmBlock = document.getElementById('limit-meters-block');
    if (State.isPro && lmBlock) lmBlock.style.display = 'none';
  }

  const undoBtn = document.getElementById('undo-btn');
  const redoBtn = document.getElementById('redo-btn');
  if (undoBtn) undoBtn.disabled = State.undoStack.length === 0;
  if (redoBtn) redoBtn.disabled = State.redoStack.length === 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNDO / REDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function snapshotIR() {
  return State.annotations.map(a => ({
    id: a.id,
    type: a.type,
    page: a.page,
    x: a.x, y: a.y,
    w: a.w, h: a.h,
    content: a.content,
    style: a.style ? { ...a.style } : undefined,
    assetId: a.assetId,
    imgUrl: a.imgUrl,
    color: a.color,
  }));
}

function pushHistory() {
  const snapshot = snapshotIR();
  State.undoStack.push(snapshot);
  if (State.undoStack.length > 50) State.undoStack.shift();
  State.redoStack = [];
  updateStatusBar();
}

function restoreIR(snapshot) {
  clearAnnotationsFromDOM();
  State.annotations = snapshot.map(s => ({ ...s }));
  State.annotations
    .filter(a => a.page === State.currentPage)
    .forEach(a => renderAnnotationEl(a));
  updateStatusBar();
}

function undo() {
  if (State.undoStack.length === 0) return;
  State.redoStack.push(snapshotIR());
  const prev = State.undoStack.pop();
  restoreIR(prev);
  toast('Undo (' + State.undoStack.length + ' left)', 'info');
}

function redo() {
  if (State.redoStack.length === 0) return;
  State.undoStack.push(snapshotIR());
  const next = State.redoStack.pop();
  restoreIR(next);
  toast('Redo', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZOOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MIN_ZOOM = 0.5;
const MAX_ZOOM = 3.0;
const ZOOM_STEP = 0.25;

function adjustZoom(delta) {
  const newZoom = Math.round((State.zoom + delta) * 100) / 100;
  setZoom(Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom)));
}

function fitToWidth() {
  if (!State.viewport) return;
  const scroll = document.getElementById('canvas-scroll');
  const availW = scroll.clientWidth - 80;
  const pdfNaturalW = State.viewport.width / State.zoom;
  const newZoom = availW / pdfNaturalW;
  setZoom(Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, Math.round(newZoom * 100) / 100)));
}

async function setZoom(newZoom) {
  if (!State.page) return;
  State.zoom = newZoom;
  document.getElementById('zoom-level').textContent = Math.round(newZoom * 100) + '%';
  await renderPage(State.currentPage);
}

document.addEventListener('wheel', (e) => {
  if (!e.ctrlKey || !State.page) return;
  e.preventDefault();
  const delta = e.deltaY < 0 ? ZOOM_STEP : -ZOOM_STEP;
  adjustZoom(delta);
}, { passive: false });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE REORDER + DELETE + ROTATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let dragSrcIdx = null;

function buildThumbItem(pageOrigIdx, displayIdx, totalPages) {
  const item = document.createElement('div');
  item.className = 'thumb-item' + ((displayIdx + 1) === State.currentPage ? ' active' : '');
  item.dataset.displayIdx = displayIdx;
  item.dataset.origIdx = pageOrigIdx;
  item.draggable = true;

  const preview = document.createElement('div');
  preview.className = 'thumb-preview';
  item.appendChild(preview);

  const bar = document.createElement('div');
  bar.className = 'thumb-bar';

  const handle = document.createElement('span');
  handle.className = 'thumb-drag-handle';
  handle.innerHTML = 'â ¿';
  handle.title = 'Drag to reorder';

  const lbl = document.createElement('span');
  lbl.className = 'thumb-label';
  lbl.textContent = 'P' + (displayIdx + 1) + '/' + totalPages;

  const actions = document.createElement('div');
  actions.className = 'page-actions';

  const rotBtn = document.createElement('button');
  rotBtn.className = 'page-act-btn rot';
  rotBtn.title = 'Rotate 90Â°';
  rotBtn.innerHTML = 'â†»';
  rotBtn.onclick = (e) => { e.stopPropagation(); rotatePage(pageOrigIdx); };

  const delBtn = document.createElement('button');
  delBtn.className = 'page-act-btn del';
  delBtn.title = 'Delete page';
  delBtn.innerHTML = 'Ã—';
  delBtn.onclick = (e) => { e.stopPropagation(); deletePage(displayIdx); };

  actions.appendChild(rotBtn);
  actions.appendChild(delBtn);
  bar.appendChild(handle);
  bar.appendChild(lbl);
  bar.appendChild(actions);
  item.appendChild(bar);

  item.addEventListener('dragstart', (e) => {
    dragSrcIdx = displayIdx;
    item.classList.add('dragging-thumb');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', String(displayIdx));
  });
  item.addEventListener('dragend', () => {
    item.classList.remove('dragging-thumb');
    document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('drag-over'));
  });
  item.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('drag-over'));
    item.classList.add('drag-over');
  });
  item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
  item.addEventListener('drop', (e) => {
    e.preventDefault();
    item.classList.remove('drag-over');
    const destIdx = displayIdx;
    if (dragSrcIdx === null || dragSrcIdx === destIdx) return;
    const moved = State.pageMap.splice(dragSrcIdx, 1)[0];
    State.pageMap.splice(destIdx, 0, moved);
    dragSrcIdx = null;
    rebuildThumbnails();
    const newDisplayPage = destIdx + 1;
    renderPage(newDisplayPage);
    toast(`Page moved to position ${newDisplayPage}`, 'info');
  });

  item.addEventListener('click', (e) => {
    if (e.target.closest('.page-actions')) return;
    renderPage(displayIdx + 1);
  });

  return item;
}

function rebuildThumbnails() {
  const container = document.getElementById('page-thumbs');
  container.innerHTML = '';
  State.pageMap.forEach((origIdx, displayIdx) => {
    const item = buildThumbItem(origIdx, displayIdx, State.pageMap.length);
    const cached = State._thumbCanvases?.[origIdx];
    const preview = item.querySelector('.thumb-preview');
    if (cached && preview) {
      const clone = document.createElement('canvas');
      clone.className = 'thumb-canvas';
      clone.width = cached.width;
      clone.height = cached.height;
      clone.getContext('2d').drawImage(cached, 0, 0);
      const rot = State.pageRotations?.[origIdx] || 0;
      if (rot) clone.style.transform = `rotate(${rot}deg)`;
      preview.appendChild(clone);
    } else if (preview) {
      preview.style.background = 'var(--surface)';
      preview.innerHTML = '<span style="font-size:20px;color:var(--text3)">ğŸ“„</span>';
    }
    container.appendChild(item);
  });
  const badge = document.getElementById('page-count-badge');
  if (badge) badge.textContent = State.pageMap.length + 'pp';
  document.querySelectorAll('.thumb-item').forEach((el, i) => {
    el.classList.toggle('active', i + 1 === State.currentPage);
  });
}

function deletePage(displayIdx) {
  if (State.pageMap.length <= 1) {
    toast('Cannot delete the only page', 'error');
    return;
  }
  const origIdx = State.pageMap[displayIdx];
  State.pageMap.splice(displayIdx, 1);
  const oldPageNum = displayIdx + 1;
  State.annotations = State.annotations.filter(a => a.page !== oldPageNum);
  rebuildThumbnails();
  const newPage = Math.min(displayIdx + 1, State.pageMap.length);
  renderPage(newPage);
  toast(`Page ${displayIdx + 1} deleted Â· ${State.pageMap.length} pages remain`, 'info');
}

function rotatePage(origIdx) {
  const cur = State.pageRotations[origIdx] || 0;
  State.pageRotations[origIdx] = (cur + 90) % 360;
  const displayIdx = State.pageMap.indexOf(origIdx);
  if (displayIdx + 1 === State.currentPage) {
    renderPage(State.currentPage);
  }
  toast(`Page rotated to ${State.pageRotations[origIdx]}Â°`, 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function handleFileInput(input) {
  const file = input.files[0];
  if (!file) return;
  input.value = '';
  loadPDF(file);
}

async function loadPDF(file) {
  setLoading(true, 'ğŸ”’ Securing PDF locallyâ€¦', 10);

  try {
    const buf = await file.arrayBuffer();
    State.originalBuffer = buf;

    setLoading(true, 'ğŸ§¹ Sanitizing PDF dictionaryâ€¦', 35);
    try {
      const tempDoc = await PDFLib.PDFDocument.load(buf, { ignoreEncryption: true });
      const catalog = tempDoc.catalog;
      ['/OpenAction', '/AA', '/JS', '/JavaScript', '/URI'].forEach(key => {
        try { catalog.delete(PDFLib.PDFName.of(key.slice(1))); } catch {}
      });
      const pages = tempDoc.getPages();
      pages.forEach(page => {
        try { page.node.delete(PDFLib.PDFName.of('AA')); } catch {}
        try { page.node.delete(PDFLib.PDFName.of('JS')); } catch {}
      });
      const cleanBytes = await tempDoc.save({ useObjectStreams: false });
      State.originalBuffer = cleanBytes.buffer;
    } catch (sanitizeErr) {
      console.warn('Sanitizer skipped:', sanitizeErr.message);
      State.originalBuffer = buf;
    }

    setLoading(true, 'ğŸ“ Building coordinate mapâ€¦', 65);
    await delay(150);

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const pdfData = new Uint8Array(State.originalBuffer.slice(0));
    const doc = await pdfjsLib.getDocument({ data: pdfData }).promise;
    State.pdfDoc = doc;
    State.pageCount = doc.numPages;
    State.pageMap = Array.from({ length: State.pageCount }, (_, i) => i);
    State.currentPage = 1;
    State.annotations = [];
    State.undoStack = [];
    State.redoStack = [];
    State.pageRotations = {};

    setLoading(true, 'ğŸ–¼ Rendering pagesâ€¦', 80);
    await delay(100);

    document.getElementById('dropzone').style.display = 'none';
    document.getElementById('canvas-scroll').style.display = 'flex';
    document.getElementById('close-btn').style.display = 'flex';

    await renderPage(1);
    await buildThumbnails(doc);

    setLoading(false);

    document.getElementById('sb-file').textContent = `ğŸ“„ ${file.name}`;
    document.getElementById('sb-pages').textContent = `PAGE 1 / ${State.pageCount}`;

    updateStatusBar();
    trackEvent('pdf_opened', { pages: State.pageCount });
    toast(`${file.name} loaded Â· ${State.pageCount} pages Â· Privacy: SECURE`, 'success');
  } catch (e) {
    setLoading(false);
    toast('Failed to open PDF: ' + e.message, 'error');
    console.error(e);
  }
}

async function delay(ms) {
  return new Promise(r => setTimeout(r, ms));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function renderPage(pageNum) {
  const origPageIdx = State.pageMap[pageNum - 1];
  const pdfPageNum = (origPageIdx !== undefined ? origPageIdx : pageNum - 1) + 1;
  const rotation = State.pageRotations[origPageIdx !== undefined ? origPageIdx : pageNum - 1] || 0;
  
  const page = await State.pdfDoc.getPage(pdfPageNum);
  State.page = page;
  const viewport = page.getViewport({ scale: State.zoom, rotation });
  State.viewport = viewport;

  const canvas = document.getElementById('pdf-bg-canvas');
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  const ctx = canvas.getContext('2d');

  await page.render({ canvasContext: ctx, viewport }).promise;

  clearAnnotationsFromDOM();

  const overlay = document.getElementById('overlay');
  overlay.style.width = viewport.width + 'px';
  overlay.style.height = viewport.height + 'px';

  State.annotations
    .filter(a => a.page === pageNum)
    .forEach(a => renderAnnotationEl(a));

  State.currentPage = pageNum;
  const totalDisplay = State.pageMap.length || State.pageCount;
  document.getElementById('sb-pages').textContent = `PAGE ${pageNum} / ${totalDisplay}`;
  document.getElementById('zoom-level').textContent = Math.round(State.zoom * 100) + '%';

  document.querySelectorAll('.thumb-item').forEach((el, i) => {
    const isActive = i + 1 === pageNum;
    el.classList.toggle('active', isActive);
    if (isActive) el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  });
}

function clearAnnotationsFromDOM() {
  document.querySelectorAll('.annotation').forEach(el => el.remove());
}

async function buildThumbnails(doc) {
  State._thumbCanvases = {};
  for (let i = 1; i <= doc.numPages; i++) {
    const page = await doc.getPage(i);
    const vp = page.getViewport({ scale: 0.2 });
    const c = document.createElement('canvas');
    c.width = vp.width;
    c.height = vp.height;
    await page.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
    State._thumbCanvases[i - 1] = c;
  }
  rebuildThumbnails();
  const badge = document.getElementById('page-count-badge');
  if (badge) badge.textContent = doc.numPages + 'pp';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COORDINATE TRANSFORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function screenToPdf(sx, sy) {
  const vp = State.viewport;
  if (!vp) return { x: sx, y: sy };
  const [a, b, c, d, e, f] = vp.transform;
  const det = a * d - b * c;
  if (Math.abs(det) < 1e-10) return { x: sx, y: sy };
  const ia = d / det, ib = -b / det;
  const ic = -c / det, id2 = a / det;
  const ie = (c * f - d * e) / det;
  const fi = (b * e - a * f) / det;
  return {
    x: parseFloat((ia * sx + ic * sy + ie).toFixed(4)),
    y: parseFloat((ib * sx + id2 * sy + fi).toFixed(4))
  };
}

function pdfToScreen(px, py) {
  const vp = State.viewport;
  if (!vp) return { x: px, y: py };
  const [a, b, c, d, e, f] = vp.transform;
  return {
    x: a * px + c * py + e,
    y: b * px + d * py + f,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setTool(name) {
  State.tool = name;
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  const el = document.getElementById('tool-' + name);
  if (el) el.classList.add('active');

  const overlay = document.getElementById('overlay');
  const drawTools = ['whiteout','highlight','redact'];
  overlay.style.cursor = name === 'select' ? 'default'
    : (name === 'text' || name === 'edittext') ? 'text'
    : drawTools.includes(name) ? 'crosshair' : 'crosshair';

  const to = document.getElementById('text-options');
  to.classList.toggle('show', name === 'text' || name === 'edittext');

  document.getElementById('sb-tool').textContent = 'TOOL: ' + name.toUpperCase();
  document.querySelectorAll('.annotation').forEach(el => el.classList.remove('selected'));
}

function triggerImageUpload() {
  document.getElementById('image-input').click();
}

async function handleImageInput(input) {
  const file = input.files[0];
  input.value = '';
  if (!State.page) {
    toast('Please open a PDF document first.', 'error');
    return;
  }
  if (!file) return;

  const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
  if (!validTypes.includes(file.type)) {
    toast('Only JPG and PNG images are supported.', 'error');
    return;
  }

  try {
    const buf = await file.arrayBuffer();
    const bytes = new Uint8Array(buf);
    const id = 'asset_' + Date.now();
    State.assetStore.set(id, bytes);

    const url = URL.createObjectURL(new Blob([bytes], { type: file.type }));

    const scrollContainer = document.getElementById('canvas-scroll');
    const pageWrapper = document.getElementById('page-wrapper');
    const scrollCX = scrollContainer.scrollLeft + scrollContainer.clientWidth / 2;
    const scrollCY = scrollContainer.scrollTop  + scrollContainer.clientHeight / 2;
    const cx = Math.max(20, Math.min(scrollCX - pageWrapper.offsetLeft, pageWrapper.offsetWidth  - 20));
    const cy = Math.max(20, Math.min(scrollCY - pageWrapper.offsetTop,  pageWrapper.offsetHeight - 20));

    const pdf = screenToPdf(cx, cy);

    const ann = {
      id: 'ann_' + (State.annIdCounter++),
      type: 'image',
      page: State.currentPage,
      x: pdf.x, y: pdf.y,
      w: 150, h: 80,
      assetId: id,
      imgUrl: url,
    };
    State.annotations.push(ann);
    pushHistory();
    renderAnnotationEl(ann);
    toast('Image placed â€” drag to reposition, resize with corner handle.', 'success');
    updateStatusBar();
  } catch (e) {
    console.error(e);
    toast('Failed to load image. Try a standard JPG or PNG.', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANNOTATION RENDERING & INTERACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAnnotationEl(ann) {
  const overlay = document.getElementById('overlay');
  const sc = pdfToScreen(ann.x, ann.y);

  const el = document.createElement('div');
  el.className = 'annotation';
  el.dataset.id = ann.id;
  el.style.left = sc.x + 'px';
  el.style.top = sc.y + 'px';

  if (ann.type === 'text') {
    el.classList.add('text-ann');
    el.contentEditable = 'false';
    el.textContent = ann.content || '';
    el.style.fontSize = ((ann.style?.size || 14) * State.zoom) + 'px';
    el.style.fontFamily = ann.style?.font || 'Arial';
    el.style.color = ann.style?.color || '#000';
    el.title = 'Double-click to edit text';
    
    // Handle resize via CSS resize property
    el.addEventListener('input', () => {
      const a = State.annotations.find(a => a.id === ann.id);
      if (a) a.content = el.textContent;
    });
    
    // Sync dimensions after resize
    const resizeObserver = new ResizeObserver(entries => {
      for (let entry of entries) {
        const a = State.annotations.find(a => a.id === ann.id);
        if (a) {
          a.w = entry.contentRect.width / State.zoom;
          a.h = entry.contentRect.height / State.zoom;
        }
      }
    });
    resizeObserver.observe(el);
    
  } else if (ann.type === 'whiteout') {
    el.classList.add('rect-ann');
    el.style.width = (ann.w * State.zoom) + 'px';
    el.style.height = (ann.h * State.zoom) + 'px';
    el.style.background = ann.color || 'white';
  } else if (ann.type === 'highlight') {
    el.classList.add('highlight-ann');
    el.style.width = (ann.w * State.zoom) + 'px';
    el.style.height = (ann.h * State.zoom) + 'px';
    el.style.background = 'rgba(255,235,59,0.38)';
  } else if (ann.type === 'redact') {
    el.classList.add('redact-ann');
    el.style.width = (ann.w * State.zoom) + 'px';
    el.style.height = (ann.h * State.zoom) + 'px';
    el.style.background = '#000';
  } else if (ann.type === 'image') {
    el.classList.add('img-ann');
    el.style.width = (ann.w * State.zoom) + 'px';
    el.style.height = (ann.h * State.zoom) + 'px';
    const img = document.createElement('img');
    img.src = ann.imgUrl;
    el.appendChild(img);

    const rh = document.createElement('div');
    rh.className = 'resize-handle';
    el.appendChild(rh);
    setupResize(el, rh, ann);
    
    // Also use ResizeObserver for image annotations
    const resizeObserver = new ResizeObserver(entries => {
      for (let entry of entries) {
        const a = State.annotations.find(a => a.id === ann.id);
        if (a) {
          a.w = entry.contentRect.width / State.zoom;
          a.h = entry.contentRect.height / State.zoom;
        }
      }
    });
    resizeObserver.observe(el);
  }

  const del = document.createElement('button');
  del.className = 'ann-delete';
  del.innerHTML = 'Ã—';
  del.onclick = (e) => {
    e.stopPropagation();
    pushHistory();
    State.annotations = State.annotations.filter(a => a.id !== ann.id);
    el.remove();
    updateStatusBar();
  };
  el.appendChild(del);

  const chip = document.createElement('div');
  chip.className = 'ann-type-chip';
  const chipLabels = { text: 'TEXT', whiteout: 'WHITEOUT', image: 'IMAGE', edittext: 'PATCH' };
  chip.textContent = chipLabels[ann.type] || ann.type.toUpperCase();
  el.appendChild(chip);

  ['tl','tr','bl','br'].forEach(pos => {
    const ch = document.createElement('div');
    ch.className = `corner-handle ${pos}`;
    if (pos === 'br' && (ann.type === 'whiteout' || ann.type === 'highlight' || ann.type === 'redact' || ann.type === 'image')) {
      ch.style.cursor = 'se-resize';
      setupResize(el, ch, ann);
    } else {
      ch.style.pointerEvents = 'none';
    }
    el.appendChild(ch);
  });

  setupDrag(el, ann);
  el.addEventListener('click', (e) => {
    if (State.tool !== 'select') return;
    e.stopPropagation();
    document.querySelectorAll('.annotation').forEach(a => a.classList.remove('selected'));
    el.classList.add('selected');
  });

  overlay.appendChild(el);
  ann.el = el;
}

function setupDrag(el, ann) {
  let ox, oy, dragging = false, movedDuringDrag = false;
  let isEditing = false;

  if (ann.type === 'text') {
    el.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      isEditing = true;
      el.contentEditable = 'true';
      el.classList.add('editing');
      el.focus();
      const range = document.caretRangeFromPoint?.(e.clientX, e.clientY);
      if (range) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    });

    el.addEventListener('blur', () => {
      isEditing = false;
      el.classList.remove('editing');
      const a = State.annotations.find(a => a.id === ann.id);
      if (a) a.content = el.textContent;
    });

    el.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        el.blur();
      }
      e.stopPropagation();
    });
  }

  el.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('ann-delete')) return;
    if (e.target.classList.contains('resize-handle')) return;
    if (e.target.classList.contains('corner-handle')) return;
    if (ann.type === 'text' && isEditing) return;

    if (ann.type === 'text' && isEditing === false) {
      el.contentEditable = 'false';
    }

    dragging = true;
    movedDuringDrag = false;
    ox = e.clientX - el.offsetLeft;
    oy = e.clientY - el.offsetTop;
    el.style.cursor = 'grabbing';
    document.body.style.cursor = 'grabbing';
    e.preventDefault();
  });

  document.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    movedDuringDrag = true;
    const nx = e.clientX - ox;
    const ny = e.clientY - oy;
    el.style.left = nx + 'px';
    el.style.top = ny + 'px';
    const pdf = screenToPdf(nx, ny);
    ann.x = pdf.x;
    ann.y = pdf.y;
  });

  document.addEventListener('mouseup', () => {
    if (dragging) {
      if (movedDuringDrag) pushHistory();
      dragging = false;
      el.style.cursor = ann.type === 'text' ? 'move' : 'move';
      document.body.style.cursor = '';
    }
  });
}

function setupResize(el, handle, ann) {
  handle.addEventListener('mousedown', (e) => {
    e.stopPropagation();
    e.preventDefault();
    const startX = e.clientX;
    const startY = e.clientY;
    const startW = el.offsetWidth;
    const startH = el.offsetHeight;
    document.body.style.cursor = 'se-resize';

    const onMove = (ev) => {
      const nw = Math.max(30, startW + ev.clientX - startX);
      const nh = Math.max(20, startH + ev.clientY - startY);
      el.style.width = nw + 'px';
      el.style.height = nh + 'px';
      ann.w = nw / State.zoom;
      ann.h = nh / State.zoom;
    };
    const onUp = () => {
      pushHistory();
      document.body.style.cursor = '';
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERLAY INTERACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const overlay = document.getElementById('overlay');

const FONT_MAP = {
  'times': 'Times New Roman',
  'timesnew': 'Times New Roman',
  'georgia': 'Georgia',
  'courier': 'Courier New',
  'courier new': 'Courier New',
  'helvetica': 'Arial',
  'arial': 'Arial',
};

function matchFont(pdfFontName) {
  if (!pdfFontName) return null;
  const lower = pdfFontName.toLowerCase().replace(/[^a-z]/g, '');
  for (const [key, val] of Object.entries(FONT_MAP)) {
    if (lower.includes(key.replace(/[^a-z]/g, ''))) return val;
  }
  return null;
}

async function detectFontAtClick(sx, sy) {
  if (!State.page) return null;
  try {
    const textContent = await State.page.getTextContent();
    const vp = State.viewport;

    for (const item of textContent.items) {
      if (!item.transform || !item.width || !item.height) continue;
      const [a, b, c, d, tx, ty] = item.transform;
      const scr = pdfToScreen(tx, ty);
      const scrW = item.width * State.zoom;
      const scrH = Math.max(item.height * State.zoom, 12);
      const pad = 8;
      if (sx >= scr.x - pad && sx <= scr.x + scrW + pad &&
          sy >= scr.y - scrH - pad && sy <= scr.y + pad) {
        const fontSize = Math.round(Math.sqrt(a * a + b * b));
        const fontName = item.fontName || '';
        const matched = matchFont(fontName);
        return { fontName, matched, fontSize };
      }
    }
  } catch (e) {
    console.warn('Font detection error:', e);
  }
  return null;
}

function showFontMatch(label) {
  const badge = document.getElementById('font-match-badge');
  const lbl = document.getElementById('font-match-label');
  if (!badge || !lbl) return;
  if (label) {
    lbl.textContent = label;
    badge.classList.add('show');
    setTimeout(() => badge.classList.remove('show'), 3000);
  } else {
    badge.classList.remove('show');
  }
}

overlay.addEventListener('click', (e) => {
  if (e.target.closest('.annotation')) return;

  if (State.tool === 'text') {
    if (!State.page) return;
    const rect = overlay.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const pdf = screenToPdf(sx, sy);

    const style = {
      font: document.getElementById('font-family').value,
      size: parseInt(document.getElementById('font-size').value) || 14,
      color: document.getElementById('font-color').value,
    };

    const ann = {
      id: 'ann_' + (State.annIdCounter++),
      type: 'text',
      page: State.currentPage,
      x: pdf.x, y: pdf.y,
      w: 200, h: 50,
      content: '',
      style,
    };
    State.annotations.push(ann);
    pushHistory();
    renderAnnotationEl(ann);
    setTimeout(() => {
      if (ann.el) {
        ann.el.contentEditable = 'true';
        ann.el.classList.add('editing');
        ann.el.focus();
        const range = document.createRange();
        range.selectNodeContents(ann.el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }, 10);
    updateStatusBar();
  }

  if (State.tool === 'select') {
    document.querySelectorAll('.annotation').forEach(el => el.classList.remove('selected'));
  }
});

let whRectEl = null, whStart = null;
const DRAW_TOOLS = ['whiteout', 'highlight', 'redact'];
const DRAW_TOOL_COLORS = { whiteout: 'white', highlight: 'rgba(255,235,59,0.4)', redact: '#000' };

overlay.addEventListener('mousedown', (e) => {
  if (!DRAW_TOOLS.includes(State.tool) || !State.page) return;
  if (e.target.closest('.annotation')) return;
  e.preventDefault();
  const rect = overlay.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;
  whStart = { sx, sy };
  whRectEl = document.createElement('div');
  whRectEl.style.cssText = `position:absolute;left:${sx}px;top:${sy}px;width:0;height:0;background:${DRAW_TOOL_COLORS[State.tool]};z-index:3;pointer-events:none;border:1px dashed rgba(255,255,255,0.3);`;
  overlay.appendChild(whRectEl);
});

overlay.addEventListener('mousemove', (e) => {
  if (!DRAW_TOOLS.includes(State.tool) || !whStart || !whRectEl) return;
  const rect = overlay.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;
  const x = Math.min(sx, whStart.sx);
  const y = Math.min(sy, whStart.sy);
  whRectEl.style.left = x + 'px';
  whRectEl.style.top = y + 'px';
  whRectEl.style.width = Math.abs(sx - whStart.sx) + 'px';
  whRectEl.style.height = Math.abs(sy - whStart.sy) + 'px';
});

overlay.addEventListener('mouseup', (e) => {
  if (!DRAW_TOOLS.includes(State.tool) || !whStart || !whRectEl) return;
  const rect = overlay.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;
  const x = Math.min(sx, whStart.sx);
  const y = Math.min(sy, whStart.sy);
  const w = Math.abs(sx - whStart.sx);
  const h = Math.abs(sy - whStart.sy);
  const tool = State.tool;

  if (w < 4 || h < 4) { whRectEl.remove(); whRectEl = null; whStart = null; return; }

  const pdf = screenToPdf(x, y);
  const ann = {
    id: 'ann_' + (State.annIdCounter++),
    type: tool === 'whiteout' ? 'whiteout' : tool === 'highlight' ? 'highlight' : 'redact',
    page: State.currentPage,
    x: pdf.x, y: pdf.y,
    w: w / State.zoom,
    h: h / State.zoom,
    color: tool === 'highlight' ? 'rgba(255,235,59,0.4)' : tool === 'redact' ? '#000' : 'white',
  };
  State.annotations.push(ann);
  pushHistory();
  whRectEl.remove();
  whRectEl = null; whStart = null;
  renderAnnotationEl(ann);
  updateStatusBar();
});

const workspaceEl = document.getElementById('workspace');
workspaceEl.addEventListener('dragover', e => {
  e.preventDefault();
  document.getElementById('drop-card')?.classList.add('dragging');
});
workspaceEl.addEventListener('dragleave', () => {
  document.getElementById('drop-card')?.classList.remove('dragging');
});
workspaceEl.addEventListener('drop', e => {
  e.preventDefault();
  document.getElementById('drop-card')?.classList.remove('dragging');
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') loadPDF(file);
  else toast('Please drop a PDF file', 'error');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT STYLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateTextStyle() {
  const font = document.getElementById('font-family').value;
  const size = parseInt(document.getElementById('font-size').value) || 14;
  const color = document.getElementById('font-color').value;
  const sel = document.querySelector('.annotation.selected.text-ann');
  if (sel) {
    sel.style.fontFamily = font;
    sel.style.fontSize = (size * State.zoom) + 'px';
    sel.style.color = color;
    const id = sel.dataset.id;
    const ann = State.annotations.find(a => a.id === id);
    if (ann) ann.style = { font, size, color };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNATURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let signCanvas, signCtx, signDrawing = false;

function initSignatureCanvas() {
  signCanvas = document.getElementById('sign-canvas');
  signCtx = signCanvas.getContext('2d');
  signCtx.strokeStyle = '#000';
  signCtx.lineWidth = 2;
  signCtx.lineCap = 'round';
  signCtx.lineJoin = 'round';

  signCanvas.onmousedown = (e) => {
    signDrawing = true;
    const r = signCanvas.getBoundingClientRect();
    const sx = signCanvas.width / r.width;
    const sy = signCanvas.height / r.height;
    signCtx.beginPath();
    signCtx.moveTo((e.clientX - r.left) * sx, (e.clientY - r.top) * sy);
  };
  signCanvas.onmousemove = (e) => {
    if (!signDrawing) return;
    const r = signCanvas.getBoundingClientRect();
    const sx = signCanvas.width / r.width;
    const sy = signCanvas.height / r.height;
    signCtx.lineTo((e.clientX - r.left) * sx, (e.clientY - r.top) * sy);
    signCtx.stroke();
  };
  signCanvas.onmouseup = () => signDrawing = false;
  signCanvas.onmouseleave = () => signDrawing = false;
}

function clearSignature() {
  if (signCtx) signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
}

async function placeSignature() {
  if (!signCanvas || !State.page) return;
  closeModal('sign-modal');

  // Use toBlob with Promise wrapper
  const blob = await new Promise(resolve => signCanvas.toBlob(resolve, 'image/png'));
  if (!blob) {
    toast('Failed to create signature image', 'error');
    return;
  }
  
  const buf = await blob.arrayBuffer();
  const bytes = new Uint8Array(buf);
  const id = 'sig_' + Date.now();
  State.assetStore.set(id, bytes);
  const url = URL.createObjectURL(blob);

  const overlay = document.getElementById('overlay');
  const cx = overlay.offsetWidth / 2;
  const cy = overlay.offsetHeight / 2;
  const pdf = screenToPdf(cx, cy);

  const ann = {
    id: 'ann_' + (State.annIdCounter++),
    type: 'image',
    page: State.currentPage,
    x: pdf.x, y: pdf.y,
    w: 200, h: 70,
    assetId: id,
    imgUrl: url,
  };
  State.annotations.push(ann);
  pushHistory();
  renderAnnotationEl(ann);
  toast('Signature placed â€” drag to reposition', 'success');
  updateStatusBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LICENSE / PRO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function activateLicense() {
  const key = document.getElementById('license-input').value.trim();
  if (!key) { toast('Please enter a license key', 'error'); return; }

  setLoading(true, 'ğŸ” Verifying cryptographic signature locallyâ€¦', 50);
  await delay(100);

  let isValid = false;

  if (IS_PLACEHOLDER_KEY && key === DEMO_PRO_TOKEN) {
    isValid = true;
  } else {
    isValid = await verifyJWT(key);
  }

  setLoading(false);

  if (isValid) {
    State.isPro = true;
    try { localStorage.setItem('mypdf_pro_key', key); } catch {}
    closeModal('pro-modal');
    updateStatusBar();
    toast('ğŸ‰ Pro activated â€” signature verified locally. Zero server calls.', 'success');
  } else {
    toast('Invalid or expired license key. Signature rejected.', 'error');
    const inp = document.getElementById('license-input');
    inp.style.borderColor = 'var(--red)';
    setTimeout(() => { inp.style.borderColor = ''; }, 1500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BAKING ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function triggerBake() {
  if (!State.originalBuffer) { toast('Please open a PDF first', 'error'); return; }

  if (!checkLimit('bake')) {
    showLimitModal(`You've used all ${LIMITS.bake.free} free bakes this hour. Resets in ~${minutesUntilReset()} min. Upgrade Pro for unlimited.`);
    return;
  }

  if (!State.isPro && State.pageMap.length > LIMITS.bake.maxPages) {
    showLimitModal(`Free tier supports up to ${LIMITS.bake.maxPages} pages per export. This PDF has ${State.pageMap.length} pages. Upgrade Pro to export any size.`);
    return;
  }

  setLoading(true, 'âš™ï¸ Compiling annotationsâ€¦', 20);
  await delay(100);

  try {
    const result = await bakePdf();
    if (!result) { setLoading(false); return; }

    setLoading(true, 'ğŸ’¾ Finalizing binaryâ€¦', 85);
    await delay(100);

    const blob = new Blob([result], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'edited_mylocalpdf.pdf';
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 2000);

    setLoading(false);
    consumeLimit('bake');
    trackEvent('pdf_exported', { annotations: State.annotations.length });

    const annCount = State.annotations.length;
    const wmNote = State.isPro ? '' : ' (watermark applied to free export)';
    toast(`âœ… PDF exported Â· ${annCount} annotations${wmNote}`, 'success');
    updateStatusBar();

  } catch (e) {
    setLoading(false);
    toast('Export failed: ' + e.message, 'error');
    console.error(e);
  }
}

async function bakePdf() {
  const { PDFDocument, rgb, StandardFonts, degrees } = PDFLib;
  const errors = [];

  const srcDoc = await PDFDocument.load(State.originalBuffer, { ignoreEncryption: false });
  const srcPages = srcDoc.getPages();

  let outDoc;
  let pages;

  const pageMapChanged = State.pageMap.length !== srcPages.length
    || State.pageMap.some((origIdx, i) => origIdx !== i);
  const hasRotations = Object.keys(State.pageRotations).length > 0;

  if (pageMapChanged || hasRotations) {
    outDoc = await PDFDocument.create();
    const copiedPages = await outDoc.copyPages(srcDoc, State.pageMap);
    copiedPages.forEach((pg, displayIdx) => {
      const origIdx = State.pageMap[displayIdx];
      const rot = State.pageRotations[origIdx] || 0;
      if (rot !== 0) pg.setRotation(degrees(rot));
      outDoc.addPage(pg);
    });
    pages = outDoc.getPages();
  } else {
    outDoc = srcDoc;
    pages = srcDoc.getPages();
  }

  const helvetica = await outDoc.embedFont(StandardFonts.Helvetica);
  const fontCache = new Map();
  fontCache.set('Arial', helvetica);
  fontCache.set('Helvetica', helvetica);

  const timesFont = await outDoc.embedFont(StandardFonts.TimesRoman);
  fontCache.set('Times New Roman', timesFont);

  const courierFont = await outDoc.embedFont(StandardFonts.Courier);
  fontCache.set('Courier New', courierFont);
  fontCache.set('Georgia', timesFont);

  const pageCount = pages.length;

  for (const ann of State.annotations) {
    try {
      const pi = ann.page - 1;
      if (pi < 0 || pi >= pageCount) continue;
      const page = pages[pi];
      const { width: pw, height: ph } = page.getSize();

      const pdfX = ann.x;
      const pdfY = ann.y;

      if (ann.type === 'text') {
        const content = ann.content?.trim() || '';
        if (!content) continue;
        const style = ann.style || {};
        const fontKey = style.font || 'Arial';
        let font = fontCache.get(fontKey) || helvetica;
        const fontSize = style.size || 14;
        const col = hexToRgb(style.color || '#000000');
        const baselineOffset = fontSize * 0.75;
        const adjustedY = Math.max(0, Math.min(pdfY - baselineOffset, ph - fontSize));

        page.drawText(content, {
          x: Math.max(0, Math.min(pdfX, pw - 10)),
          y: adjustedY,
          size: fontSize,
          font,
          color: rgb(col.r, col.g, col.b),
          lineHeight: fontSize * 1.2,
          maxWidth: pw - pdfX - 10,
        });

      } else if (ann.type === 'whiteout') {
        page.drawRectangle({
          x: Math.max(0, pdfX),
          y: Math.max(0, pdfY - ann.h),
          width: ann.w, height: ann.h,
          color: rgb(1, 1, 1), borderWidth: 0,
        });

      } else if (ann.type === 'highlight') {
        page.drawRectangle({
          x: Math.max(0, pdfX),
          y: Math.max(0, pdfY - ann.h),
          width: ann.w, height: ann.h,
          color: rgb(1, 0.93, 0.23),
          opacity: 0.38,
          borderWidth: 0,
        });

      } else if (ann.type === 'redact') {
        page.drawRectangle({
          x: Math.max(0, pdfX),
          y: Math.max(0, pdfY - ann.h),
          width: ann.w, height: ann.h,
          color: rgb(0, 0, 0), borderWidth: 0,
        });

      } else if (ann.type === 'image') {
        const assetBytes = State.assetStore.get(ann.assetId);
        if (!assetBytes) continue;

        let embeddedImg;
        try { embeddedImg = await outDoc.embedPng(assetBytes); }
        catch {
          try { embeddedImg = await outDoc.embedJpg(assetBytes); }
          catch { errors.push({ id: ann.id, msg: 'Image format not supported' }); continue; }
        }

        page.drawImage(embeddedImg, {
          x: Math.max(0, pdfX),
          y: Math.max(0, pdfY - ann.h),
          width: ann.w || embeddedImg.width,
          height: ann.h || embeddedImg.height,
        });
      }
    } catch (e) {
      errors.push({ id: ann.id, msg: e.message });
    }
  }

  if (!State.isPro) {
    for (const page of pages) {
      const { width: pw, height: ph } = page.getSize();
      page.drawText('MyLocalPDF.com â€” Free Version', {
        x: pw / 2 - 120,
        y: ph / 2 - 10,
        size: 24,
        font: helvetica,
        color: rgb(0.6, 0.6, 0.6),
        rotate: degrees(40),
        opacity: 0.25,
      });
      page.drawText('Created with MyLocalPDF.com â€” Upgrade to remove watermark', {
        x: 10,
        y: 8,
        size: 7,
        font: helvetica,
        color: rgb(0.5, 0.5, 0.5),
        opacity: 0.6,
      });
    }
  }

  if (errors.length > 0) {
    console.warn('Bake warnings:', errors);
    toast(`${errors.length} annotation(s) had issues â€” rest exported fine`, 'info');
  }

  const bytes = await outDoc.save({ useObjectStreams: false, addDefaultPage: false });
  return bytes;
}

function hexToRgb(hex) {
  const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return r ? {
    r: parseInt(r[1], 16) / 255,
    g: parseInt(r[2], 16) / 255,
    b: parseInt(r[3], 16) / 255,
  } : { r: 0, g: 0, b: 0 };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOLS HUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openToolsModal() {
  document.getElementById('tools-modal').style.display = 'flex';
}

// â”€â”€ MERGE PDFs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const MergeState = { files: [] };

function openMergeModal() {
  document.getElementById('merge-modal').style.display = 'flex';
  renderMergeList();
}

function clearMerge() {
  MergeState.files = [];
  renderMergeList();
}

async function handleMergeInput(input) {
  await addMergeFiles(Array.from(input.files));
  input.value = '';
}

async function handleMergeDrop(e) {
  e.preventDefault();
  const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
  if (!files.length) { toast('Drop PDF files only.', 'error'); return; }
  await addMergeFiles(files);
}

async function addMergeFiles(files) {
  const status = document.getElementById('merge-status');
  status.textContent = 'Loadingâ€¦';
  for (const f of files) {
    try {
      const buf = await f.arrayBuffer();
      const tmp = await PDFLib.PDFDocument.load(buf, { ignoreEncryption: true });
      MergeState.files.push({ name: f.name, pages: tmp.getPageCount(), buffer: buf });
    } catch (e) {
      toast(`Could not read "${f.name}" â€” is it encrypted?`, 'error');
    }
  }
  status.textContent = MergeState.files.length ? `${MergeState.files.length} file(s) ready` : '';
  renderMergeList();
}

function renderMergeList() {
  const list = document.getElementById('merge-file-list');
  const btn = document.getElementById('merge-run-btn');
  list.innerHTML = '';
  MergeState.files.forEach((f, i) => {
    const row = document.createElement('div');
    row.className = 'merge-file-item';
    row.draggable = true;
    row.dataset.idx = i;
    row.innerHTML = `<span style="color:var(--text3);font-size:10px">â˜°</span>
      <span class="mf-name" title="${f.name}">ğŸ“„ ${f.name}</span>
      <span class="mf-pages">${f.pages}pp</span>
      <span class="mf-del" onclick="removeMergeFile(${i})">Ã—</span>`;
    row.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', String(i)); row.style.opacity='0.4'; });
    row.addEventListener('dragend', () => row.style.opacity='1');
    row.addEventListener('dragover', e => e.preventDefault());
    row.addEventListener('drop', e => {
      e.preventDefault();
      const src = parseInt(e.dataTransfer.getData('text/plain'));
      const dest = i;
      if (src === dest) return;
      const moved = MergeState.files.splice(src, 1)[0];
      MergeState.files.splice(dest, 0, moved);
      renderMergeList();
    });
    list.appendChild(row);
  });
  btn.disabled = MergeState.files.length < 2;
}

function removeMergeFile(idx) {
  MergeState.files.splice(idx, 1);
  renderMergeList();
}

async function runMerge() {
  if (MergeState.files.length < 2) return;
  const btn = document.getElementById('merge-run-btn');
  btn.disabled = true;
  btn.textContent = 'Mergingâ€¦';
  document.getElementById('merge-status').textContent = 'Building merged PDFâ€¦';
  try {
    const outDoc = await PDFLib.PDFDocument.create();
    for (const f of MergeState.files) {
      const src = await PDFLib.PDFDocument.load(f.buffer, { ignoreEncryption: true });
      const pageIndices = src.getPageIndices();
      const copied = await outDoc.copyPages(src, pageIndices);
      copied.forEach(p => outDoc.addPage(p));
    }
    const bytes = await outDoc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'merged.pdf');
    document.getElementById('merge-status').textContent = 'âœ… Done!';
    toast('Merge complete!', 'success');
    trackEvent('pdf_merged', { files: MergeState.files.length });
    closeModal('merge-modal');
    if (confirm('Merge successful! Open the merged file in the editor?')) {
      const blob = new Blob([bytes], { type: 'application/pdf' });
      const file = new File([blob], 'merged.pdf', { type: 'application/pdf' });
      loadPDF(file);
    }
  } catch (e) {
    console.error(e);
    toast('Merge failed: ' + e.message, 'error');
    document.getElementById('merge-status').textContent = 'âŒ Error: ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Merge & Download';
  }
}

// â”€â”€ SPLIT / EXTRACT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const SplitState = { selected: new Set() };

function openSplitModal() {
  if (!State.pdfDoc) { toast('Open a PDF first.', 'error'); return; }
  SplitState.selected = new Set();
  document.getElementById('split-modal').style.display = 'flex';
  buildSplitPreview();
}

function buildSplitPreview() {
  const total = State.pageMap.length || State.pageCount;
  const preview = document.getElementById('split-preview');
  document.getElementById('split-desc').textContent =
    `Select pages to extract from your ${total}-page document.`;
  preview.innerHTML = '';
  for (let i = 1; i <= total; i++) {
    const chip = document.createElement('div');
    chip.className = 'split-page-chip' + (SplitState.selected.has(i) ? ' selected' : '');
    chip.textContent = 'P' + i;
    chip.onclick = () => {
      if (SplitState.selected.has(i)) SplitState.selected.delete(i);
      else SplitState.selected.add(i);
      chip.classList.toggle('selected', SplitState.selected.has(i));
      document.getElementById('split-status').textContent =
        SplitState.selected.size ? `${SplitState.selected.size} page(s) selected` : '';
    };
    preview.appendChild(chip);
  }
}

function splitSelectAll() {
  const total = State.pageMap.length || State.pageCount;
  for (let i = 1; i <= total; i++) SplitState.selected.add(i);
  buildSplitPreview();
  document.getElementById('split-status').textContent = `${SplitState.selected.size} page(s) selected`;
}
function splitSelectNone() { SplitState.selected.clear(); buildSplitPreview(); document.getElementById('split-status').textContent = ''; }
function splitSelectOdd() {
  SplitState.selected.clear();
  const total = State.pageMap.length || State.pageCount;
  for (let i = 1; i <= total; i += 2) SplitState.selected.add(i);
  buildSplitPreview();
  document.getElementById('split-status').textContent = `${SplitState.selected.size} page(s) selected`;
}
function splitSelectEven() {
  SplitState.selected.clear();
  const total = State.pageMap.length || State.pageCount;
  for (let i = 2; i <= total; i += 2) SplitState.selected.add(i);
  buildSplitPreview();
  document.getElementById('split-status').textContent = `${SplitState.selected.size} page(s) selected`;
}

async function runSplit() {
  if (SplitState.selected.size === 0) { toast('Select at least one page.', 'error'); return; }
  if (!State.originalBuffer) { toast('No PDF loaded.', 'error'); return; }
  document.getElementById('split-status').textContent = 'Extractingâ€¦';
  try {
    const src = await PDFLib.PDFDocument.load(State.originalBuffer, { ignoreEncryption: true });
    const outDoc = await PDFLib.PDFDocument.create();
    const sorted = [...SplitState.selected].sort((a, b) => a - b);
    const origIndices = sorted.map(displayPage => State.pageMap[displayPage - 1] ?? displayPage - 1);
    const copied = await outDoc.copyPages(src, origIndices);
    copied.forEach(p => outDoc.addPage(p));
    const bytes = await outDoc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'extracted-pages.pdf');
    document.getElementById('split-status').textContent = `âœ… Extracted ${sorted.length} page(s)`;
    toast('Pages extracted!', 'success');
    trackEvent('pdf_split', { pages: sorted.length });
  } catch (e) {
    console.error(e);
    toast('Split failed: ' + e.message, 'error');
    document.getElementById('split-status').textContent = 'âŒ ' + e.message;
  }
}

// â”€â”€ BATES NUMBERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openBatesModal() {
  if (!State.isPro) {
    document.getElementById('upgrade-msg').textContent = 'Bates Numbering is a Pro feature. Upgrade to use it.';
    document.getElementById('upgrade-modal').style.display = 'flex';
    return;
  }
  if (!State.pdfDoc) { toast('Open a PDF first.', 'error'); return; }
  document.getElementById('bates-modal').style.display = 'flex';
  updateBatesPreview();
}

function updateBatesPreview() {
  const prefix = document.getElementById('bates-prefix').value;
  const start = parseInt(document.getElementById('bates-start').value) || 1;
  const pad = parseInt(document.getElementById('bates-pad').value) || 4;
  document.getElementById('bates-preview').textContent =
    prefix + String(start).padStart(pad, '0');
}

async function runBates() {
  if (!State.originalBuffer) { toast('No PDF loaded.', 'error'); return; }
  const prefix = document.getElementById('bates-prefix').value;
  const start = parseInt(document.getElementById('bates-start').value) || 1;
  const pad = parseInt(document.getElementById('bates-pad').value) || 4;
  const pos = document.getElementById('bates-pos').value;
  closeModal('bates-modal');
  toast('Applying Bates numbersâ€¦', 'info');
  try {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    const pdfDoc = await PDFDocument.load(State.originalBuffer, { ignoreEncryption: true });
    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const pages = pdfDoc.getPages();
    pages.forEach((page, idx) => {
      const { width: pw, height: ph } = page.getSize();
      const label = prefix + String(start + idx).padStart(pad, '0');
      const fontSize = 9;
      const textW = font.widthOfTextAtSize(label, fontSize);
      const margin = 18;
      let x, y;
      switch (pos) {
        case 'br': x = pw - textW - margin; y = margin; break;
        case 'bl': x = margin; y = margin; break;
        case 'bc': x = (pw - textW) / 2; y = margin; break;
        case 'tr': x = pw - textW - margin; y = ph - margin - fontSize; break;
        case 'tl': x = margin; y = ph - margin - fontSize; break;
        default:   x = pw - textW - margin; y = margin;
      }
      page.drawText(label, { x, y, size: fontSize, font, color: rgb(0.1, 0.1, 0.1), opacity: 0.85 });
    });
    const bytes = await pdfDoc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'bates-numbered.pdf');
    toast('Bates numbering applied!', 'success');
  } catch (e) {
    console.error(e);
    toast('Bates failed: ' + e.message, 'error');
  }
}

// â”€â”€ METADATA SCRUBBER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function runMetaScrub() {
  if (!State.isPro) {
    document.getElementById('upgrade-msg').textContent = 'Metadata Scrubbing is a Pro feature. Upgrade to use it.';
    document.getElementById('upgrade-modal').style.display = 'flex';
    return;
  }
  if (!State.originalBuffer) { toast('Open a PDF first.', 'error'); return; }
  toast('Scrubbing metadataâ€¦', 'info');
  try {
    const pdfDoc = await PDFLib.PDFDocument.load(State.originalBuffer, { ignoreEncryption: true });
    pdfDoc.setTitle('');
    pdfDoc.setAuthor('');
    pdfDoc.setSubject('');
    pdfDoc.setKeywords([]);
    pdfDoc.setProducer('MyLocalPDF Privacy Engine');
    pdfDoc.setCreator('');
    pdfDoc.setCreationDate(new Date(0));
    pdfDoc.setModificationDate(new Date());
    const bytes = await pdfDoc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'scrubbed.pdf');
    toast('âœ… Metadata scrubbed â€” author, dates, and software tags removed.', 'success');
  } catch (e) {
    console.error(e);
    toast('Scrub failed: ' + e.message, 'error');
  }
}

// â”€â”€ IMAGES â†’ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const Img2PdfState = { files: [] };

function openImg2PdfModal() {
  document.getElementById('img2pdf-modal').style.display = 'flex';
  renderImg2PdfList();
}

function clearImg2Pdf() {
  Img2PdfState.files.forEach(f => URL.revokeObjectURL(f.url));
  Img2PdfState.files = [];
  renderImg2PdfList();
}

async function handleImg2PdfInput(input) {
  await addImg2PdfFiles(Array.from(input.files));
  input.value = '';
}

async function handleImg2PdfDrop(e) {
  e.preventDefault();
  const files = Array.from(e.dataTransfer.files)
    .filter(f => ['image/jpeg','image/png','image/jpg'].includes(f.type));
  if (!files.length) { toast('JPG and PNG only.', 'error'); return; }
  await addImg2PdfFiles(files);
}

async function addImg2PdfFiles(files) {
  for (const f of files) {
    if (!['image/jpeg','image/png','image/jpg'].includes(f.type)) continue;
    const buf = await f.arrayBuffer();
    const url = URL.createObjectURL(new Blob([new Uint8Array(buf)], { type: f.type }));
    Img2PdfState.files.push({ name: f.name, type: f.type, buffer: buf, url });
  }
  renderImg2PdfList();
  document.getElementById('img2pdf-status').textContent =
    Img2PdfState.files.length ? `${Img2PdfState.files.length} image(s) ready` : '';
}

function renderImg2PdfList() {
  const list = document.getElementById('img2pdf-list');
  const btn = document.getElementById('img2pdf-run-btn');
  list.innerHTML = '';
  Img2PdfState.files.forEach((f, i) => {
    const item = document.createElement('div');
    item.className = 'img2pdf-thumb';
    item.draggable = true;
    item.dataset.idx = i;
    item.innerHTML = `<img src="${f.url}" alt="${f.name}" title="${f.name}"/>
      <button class="it-del" onclick="removeImg2PdfFile(${i})">Ã—</button>`;
    item.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', String(i)); item.style.opacity='0.4'; });
    item.addEventListener('dragend', () => item.style.opacity='1');
    item.addEventListener('dragover', e => e.preventDefault());
    item.addEventListener('drop', e => {
      e.preventDefault();
      const src = parseInt(e.dataTransfer.getData('text/plain'));
      if (src === i) return;
      const moved = Img2PdfState.files.splice(src, 1)[0];
      Img2PdfState.files.splice(i, 0, moved);
      renderImg2PdfList();
    });
    list.appendChild(item);
  });
  btn.disabled = Img2PdfState.files.length === 0;
}

function removeImg2PdfFile(idx) {
  URL.revokeObjectURL(Img2PdfState.files[idx].url);
  Img2PdfState.files.splice(idx, 1);
  renderImg2PdfList();
}

async function runImg2Pdf() {
  if (Img2PdfState.files.length === 0) return;
  const btn = document.getElementById('img2pdf-run-btn');
  btn.disabled = true;
  btn.textContent = 'Convertingâ€¦';
  document.getElementById('img2pdf-status').textContent = 'Building PDFâ€¦';
  try {
    const { PDFDocument } = PDFLib;
    const outDoc = await PDFDocument.create();
    for (const f of Img2PdfState.files) {
      const bytes = new Uint8Array(f.buffer);
      let img;
      try { img = await outDoc.embedPng(bytes); }
      catch { img = await outDoc.embedJpg(bytes); }
      const page = outDoc.addPage([img.width, img.height]);
      page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
    }
    const bytes = await outDoc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'images-to-pdf.pdf');
    document.getElementById('img2pdf-status').textContent = `âœ… ${Img2PdfState.files.length} image(s) converted`;
    toast('PDF created!', 'success');
    trackEvent('img2pdf_converted', { images: Img2PdfState.files.length });
    closeModal('img2pdf-modal');
    if (confirm('Conversion successful! Open the PDF in the editor?')) {
      const blob = new Blob([bytes], { type: 'application/pdf' });
      const file = new File([blob], 'images-to-pdf.pdf', { type: 'application/pdf' });
      loadPDF(file);
    }
  } catch (e) {
    console.error(e);
    toast('Conversion failed: ' + e.message, 'error');
    document.getElementById('img2pdf-status').textContent = 'âŒ ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Convert & Download';
  }
}

// â”€â”€ CLOSE DOCUMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function closeDocument() {
  State.pdfDoc = null;
  State.pageCount = 0;
  State.currentPage = 1;
  State.originalBuffer = null;
  State.annotations = [];
  State.undoStack = [];
  State.redoStack = [];
  State.assetStore.clear();
  State.pageMap = [];
  State.pageRotations = {};
  State._thumbCanvases = {};

  document.getElementById('canvas-scroll').style.display = 'none';
  document.getElementById('dropzone').style.display = 'flex';
  document.getElementById('close-btn').style.display = 'none';
  document.getElementById('sb-file').textContent = 'No file loaded';
  document.getElementById('sb-pages').textContent = 'â€”';
  document.getElementById('page-thumbs').innerHTML = '';
  document.getElementById('file-input').value = '';

  document.querySelectorAll('.modal-backdrop').forEach(el => el.style.display = 'none');

  updateStatusBar();
  toast('Document closed', 'info');
}

// â”€â”€ PAGE ORGANISER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let orgPageMap = [];
let orgRotations = {};

function openPageOrgModal() {
  if (!State.pdfDoc) { toast('Open a PDF first.', 'error'); return; }
  orgPageMap = [...State.pageMap];
  orgRotations = { ...State.pageRotations };
  renderOrganiserGrid();
  document.getElementById('pageorg-modal').style.display = 'flex';
}

function renderOrganiserGrid() {
  const grid = document.getElementById('org-grid');
  grid.innerHTML = '';

  orgPageMap.forEach((origIdx, displayIdx) => {
    const card = document.createElement('div');
    card.className = 'org-card';
    card.draggable = true;
    card.dataset.displayIdx = displayIdx;

    const wrap = document.createElement('div');
    wrap.className = 'org-thumb-wrap';

    const cachedCanvas = State._thumbCanvases?.[origIdx];
    if (cachedCanvas) {
      const mini = document.createElement('canvas');
      mini.width = cachedCanvas.width;
      mini.height = cachedCanvas.height;
      mini.getContext('2d').drawImage(cachedCanvas, 0, 0);
      const rot = orgRotations[origIdx] || 0;
      mini.style.transform = `rotate(${rot}deg)`;
      if (rot % 180 !== 0) {
        const scale = Math.min(140 / cachedCanvas.height, 160 / cachedCanvas.width) * 0.9;
        mini.style.transform = `rotate(${rot}deg) scale(${scale})`;
      }
      wrap.appendChild(mini);
    } else {
      wrap.style.background = 'var(--surface)';
      wrap.innerHTML = `<span style="font-size:28px">ğŸ“„</span>`;
    }

    const bar = document.createElement('div');
    bar.className = 'org-card-bar';

    const num = document.createElement('span');
    num.className = 'org-num';
    num.textContent = `P${displayIdx + 1}`;
    if (origIdx !== displayIdx) {
      num.title = `Original page ${origIdx + 1}`;
      num.style.color = 'var(--amber)';
    }

    const acts = document.createElement('div');
    acts.className = 'org-actions';

    const rotBtn = document.createElement('button');
    rotBtn.className = 'org-btn rot';
    rotBtn.title = 'Rotate 90Â°';
    rotBtn.textContent = 'â†»';
    rotBtn.onclick = (e) => { e.stopPropagation(); rotatePageOrg(displayIdx); };

    const delBtn = document.createElement('button');
    delBtn.className = 'org-btn del';
    delBtn.title = 'Delete page';
    delBtn.textContent = 'Ã—';
    delBtn.onclick = (e) => { e.stopPropagation(); deletePageOrg(displayIdx); };

    acts.appendChild(rotBtn);
    acts.appendChild(delBtn);
    bar.appendChild(num);
    bar.appendChild(acts);

    card.appendChild(wrap);
    card.appendChild(bar);

    card.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', String(displayIdx));
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(() => card.classList.add('dragging'), 0);
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      document.querySelectorAll('.org-card').forEach(c => c.classList.remove('drag-target'));
    });
    card.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('.org-card').forEach(c => c.classList.remove('drag-target'));
      card.classList.add('drag-target');
    });
    card.addEventListener('dragleave', () => card.classList.remove('drag-target'));
    card.addEventListener('drop', e => {
      e.preventDefault();
      card.classList.remove('drag-target');
      const srcIdx = parseInt(e.dataTransfer.getData('text/plain'));
      if (isNaN(srcIdx) || srcIdx === displayIdx) return;
      const moved = orgPageMap.splice(srcIdx, 1)[0];
      orgPageMap.splice(displayIdx, 0, moved);
      renderOrganiserGrid();
    });

    grid.appendChild(card);
  });
}

function rotatePageOrg(displayIdx) {
  const origIdx = orgPageMap[displayIdx];
  orgRotations[origIdx] = ((orgRotations[origIdx] || 0) + 90) % 360;
  renderOrganiserGrid();
}

function deletePageOrg(displayIdx) {
  if (orgPageMap.length <= 1) { toast('Cannot delete the last page.', 'error'); return; }
  orgPageMap.splice(displayIdx, 1);
  renderOrganiserGrid();
}

function applyOrganiserChanges() {
  State.pageMap = [...orgPageMap];
  State.pageRotations = { ...orgRotations };
  rebuildThumbnails();
  if (State.currentPage > State.pageMap.length) State.currentPage = State.pageMap.length;
  renderPage(State.currentPage);
  closeModal('pageorg-modal');
  toast(`Page order applied â€” ${State.pageMap.length} pages`, 'success');
}

// â”€â”€ SHARED DOWNLOAD HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function downloadBytes(bytes, filename) {
  const blob = new Blob([bytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM FILLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function detectAndFillForms() {
  if (!State.pdfDoc) { toast('Open a PDF first.', 'error'); return; }
  if (!checkLimit('formfill')) {
    showLimitModal(`You've used all ${LIMITS.formfill.free} free form fills today. Upgrade Pro for unlimited.`);
    return;
  }
  
  document.getElementById('formfill-modal').style.display = 'flex';
  document.getElementById('form-detect-status').textContent = 'Detecting form fields...';
  document.getElementById('form-field-list').innerHTML = '';
  
  State.detectedFormFields = [];
  
  try {
    const page = await State.pdfDoc.getPage(1);
    const annotations = await page.getAnnotations();
    
    const formFields = annotations.filter(a => 
      a.fieldType === 'Tx' || a.fieldType === 'Ch' || a.fieldType === 'Btn'
    );
    
    if (formFields.length === 0) {
      document.getElementById('form-detect-status').textContent = 'No fillable form fields detected on this page. You can still add text annotations manually.';
    } else {
      document.getElementById('form-detect-status').textContent = `${formFields.length} fillable field(s) detected`;
      
      const list = document.getElementById('form-field-list');
      formFields.forEach((field, idx) => {
        const item = document.createElement('div');
        item.className = 'form-field-item';
        
        const label = document.createElement('label');
        label.innerHTML = `${field.fieldName || `Field ${idx + 1}`} <span class="field-type">${field.fieldType}</span>`;
        
        let input;
        if (field.fieldType === 'Ch') {
          input = document.createElement('select');
          (field.options || []).forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            input.appendChild(option);
          });
        } else if (field.fieldType === 'Btn') {
          input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = field.checkBox || false;
        } else {
          input = document.createElement('input');
          input.type = 'text';
          input.placeholder = 'Enter value...';
          input.value = State.savedFormData[field.fieldName] || '';
        }
        
        input.dataset.fieldName = field.fieldName;
        input.dataset.fieldType = field.fieldType;
        input.dataset.fieldIdx = idx;
        
        item.appendChild(label);
        item.appendChild(input);
        list.appendChild(item);
        
        State.detectedFormFields.push({
          name: field.fieldName,
          type: field.fieldType,
          element: input
        });
      });
    }
    
    // Load saved data templates
    renderSavedDataTemplates();
    
  } catch (e) {
    console.error(e);
    document.getElementById('form-detect-status').textContent = 'Error detecting forms: ' + e.message;
  }
}

function renderSavedDataTemplates() {
  const grid = document.getElementById('saved-data-grid');
  grid.innerHTML = '';
  
  const saved = JSON.parse(localStorage.getItem('mypdf_form_templates') || '[]');
  if (saved.length === 0) {
    grid.style.display = 'none';
    return;
  }
  
  grid.style.display = 'grid';
  saved.forEach((template, idx) => {
    const item = document.createElement('div');
    item.className = 'saved-data-item';
    item.innerHTML = `
      <div class="sd-label">${template.name}</div>
      <div class="sd-value">${Object.keys(template.data).length} fields</div>
    `;
    item.onclick = () => loadFormTemplate(template.data);
    grid.appendChild(item);
  });
}

function loadFormTemplate(data) {
  State.detectedFormFields.forEach(field => {
    if (data[field.name] !== undefined) {
      if (field.type === 'Btn') {
        field.element.checked = data[field.name];
      } else {
        field.element.value = data[field.name];
      }
    }
  });
  toast('Template loaded!', 'success');
}

function saveFormTemplate() {
  const name = prompt('Enter a name for this template:');
  if (!name) return;
  
  const data = {};
  State.detectedFormFields.forEach(field => {
    if (field.type === 'Btn') {
      data[field.name] = field.element.checked;
    } else {
      data[field.name] = field.element.value;
    }
  });
  
  const saved = JSON.parse(localStorage.getItem('mypdf_form_templates') || '[]');
  saved.push({ name, data, created: Date.now() });
  localStorage.setItem('mypdf_form_templates', JSON.stringify(saved));
  
  renderSavedDataTemplates();
  toast('Template saved!', 'success');
}

async function applyFormFilling() {
  if (!State.originalBuffer) return;
  
  try {
    const pdfDoc = await PDFLib.PDFDocument.load(State.originalBuffer);
    const form = pdfDoc.getForm();
    
    State.detectedFormFields.forEach(field => {
      try {
        if (field.type === 'Tx') {
          const textField = form.getTextField(field.name);
          if (textField) textField.setText(field.element.value);
        } else if (field.type === 'Ch') {
          const dropdown = form.getDropdown(field.name);
          if (dropdown) dropdown.select(field.element.value);
        } else if (field.type === 'Btn') {
          const checkBox = form.getCheckBox(field.name);
          if (checkBox) {
            if (field.element.checked) checkBox.check();
            else checkBox.uncheck();
          }
        }
      } catch (e) {
        console.warn('Could not fill field:', field.name, e.message);
      }
    });
    
    const bytes = await pdfDoc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'filled-form.pdf');
    consumeLimit('formfill');
    closeModal('formfill-modal');
    toast('Form filled successfully!', 'success');
    trackEvent('form_filled', { fields: State.detectedFormFields.length });
  } catch (e) {
    toast('Form filling failed: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USAGE ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function trackEvent(eventName, data = {}) {
  try {
    const stats = JSON.parse(localStorage.getItem('mypdf_stats') || '{}');
    const month = new Date().toISOString().slice(0, 7);
    if (!stats[month]) stats[month] = { merged: 0, forms: 0, compressed: 0, saved: 0 };
    
    if (eventName === 'pdf_merged') stats[month].merged += (data.files || 1);
    if (eventName === 'form_filled') stats[month].forms += 1;
    if (eventName === 'pdf_compressed') stats[month].compressed += (data.bytes || 0);
    
    localStorage.setItem('mypdf_stats', JSON.stringify(stats));
  } catch (e) {}
}

function openAnalyticsModal() {
  const stats = JSON.parse(localStorage.getItem('mypdf_stats') || '{}');
  const month = new Date().toISOString().slice(0, 7);
  const current = stats[month] || { merged: 0, forms: 0, compressed: 0 };
  
  document.getElementById('analytics-merged').textContent = current.merged;
  document.getElementById('analytics-merged-savings').textContent = `Saved $${(current.merged * 2).toFixed(0)} vs Acrobat`;
  
  document.getElementById('analytics-forms').textContent = current.forms;
  const hoursSaved = (current.forms * 20 / 60).toFixed(1);
  document.getElementById('analytics-forms-savings').textContent = `Saved ${hoursSaved} hrs vs manual`;
  
  const mbSaved = (current.compressed / 1048576).toFixed(1);
  document.getElementById('analytics-compressed').textContent = `${mbSaved} MB`;
  document.getElementById('analytics-compressed-savings').textContent = `Saved $${(mbSaved * 0.1).toFixed(2)} vs cloud storage`;
  
  const totalValue = (current.merged * 2) + (current.forms * 5) + (mbSaved * 0.1);
  document.getElementById('analytics-total-value').textContent = `$${totalValue.toFixed(0)}`;
  
  const roi = totalValue / 3;
  document.getElementById('analytics-roi').textContent = roi.toFixed(1) + 'x';
  
  document.getElementById('analytics-modal').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPRESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function selectCompressLevel(el, level) {
  document.querySelectorAll('.compress-option').forEach(opt => opt.classList.remove('selected'));
  el.classList.add('selected');
  State.compressLevel = level;
}

function openCompressModal() {
  if (!State.isPro) {
    document.getElementById('upgrade-msg').textContent = 'Advanced Compression is a Pro feature. Upgrade to use it.';
    document.getElementById('upgrade-modal').style.display = 'flex';
    return;
  }
  if (!State.originalBuffer) { toast('Open a PDF first.', 'error'); return; }
  const origKB = Math.round(State.originalBuffer.byteLength / 1024);
  const el = document.getElementById('compress-status');
  if (el) el.textContent = 'Current size: ' + origKB + ' KB';
  document.getElementById('compress-modal').style.display = 'flex';
}

async function runCompress() {
  const statusEl = document.getElementById('compress-status');
  if (statusEl) statusEl.textContent = 'Compressing...';
  
  try {
    const { PDFDocument } = PDFLib;
    const level = State.compressLevel;
    const doc = await PDFLib.PDFDocument.load(State.originalBuffer, { ignoreEncryption: true });
    
    let bytes;
    if (level === 'mca') {
      // MCA mode: aggressive compression targeting <2MB
      bytes = await doc.save({ 
        useObjectStreams: true,
        addDefaultPage: false
      });
      // If still too large, we'd need image recompression (simplified here)
      if (bytes.byteLength > 2 * 1024 * 1024) {
        toast('File still large â€” consider splitting or using images â†’ PDF with lower quality', 'info');
      }
    } else {
      bytes = await doc.save({ 
        useObjectStreams: level !== 'light',
        addDefaultPage: false
      });
    }
    
    const origKB = Math.round(State.originalBuffer.byteLength / 1024);
    const newKB = Math.round(bytes.byteLength / 1024);
    const savings = Math.round((1 - newKB / origKB) * 100);
    
    downloadBytes(bytes, 'compressed.pdf');
    consumeLimit('tools');
    closeModal('compress-modal');
    
    const msg = origKB + 'KB â†’ ' + newKB + 'KB ' + (savings > 0 ? `(${savings}% smaller)` : '(already optimised)');
    toast(msg, 'success');
    trackEvent('pdf_compressed', { bytes: State.originalBuffer.byteLength - bytes.byteLength });
  } catch(e) {
    if (statusEl) statusEl.textContent = 'Failed: ' + e.message;
    toast('Compress failed: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATIC PAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showStaticPage(pageName) {
  document.querySelectorAll('.static-page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + pageName).classList.add('active');
  document.getElementById('main-app').style.display = 'none';
}

function showHome() {
  document.querySelectorAll('.static-page').forEach(p => p.classList.remove('active'));
  document.getElementById('main-app').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OTHER TOOLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openWatermarkModal() {
  if (!State.originalBuffer) { toast('Open a PDF first.', 'error'); return; }
  updateWmPreview();
  document.getElementById('watermark-modal').style.display = 'flex';
}

function updateWmPreview() {
  const text = document.getElementById('wm-text') ? document.getElementById('wm-text').value : 'CONFIDENTIAL';
  const opacity = parseInt(document.getElementById('wm-opacity') ? document.getElementById('wm-opacity').value : 15);
  const el = document.getElementById('wm-preview-text');
  if (el) { el.textContent = text; el.style.opacity = opacity / 100; }
}

async function runWatermark() {
  try {
    const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;
    const text = document.getElementById('wm-text').value.trim() || 'CONFIDENTIAL';
    const opacity = parseFloat(document.getElementById('wm-opacity').value) / 100;
    const fontSize = parseInt(document.getElementById('wm-size').value) || 48;
    const colorParts = document.getElementById('wm-color').value.split(',').map(Number);
    const pos = document.getElementById('wm-pos').value;
    const doc = await PDFLib.PDFDocument.load(State.originalBuffer);
    const font = await doc.embedFont(StandardFonts.HelveticaBold);
    for (const page of doc.getPages()) {
      const pw = page.getSize().width, ph = page.getSize().height;
      const tw = font.widthOfTextAtSize(text, fontSize);
      if (pos === 'center') {
        page.drawText(text, { x: (pw - tw) / 2, y: ph / 2, size: fontSize, font, color: rgb(colorParts[0], colorParts[1], colorParts[2]), opacity, rotate: degrees(-35) });
      } else if (pos === 'tile') {
        for (let y = 80; y < ph; y += 160) {
          for (let x = -50; x < pw; x += tw + 60) {
            page.drawText(text, { x, y, size: fontSize * 0.55, font, color: rgb(colorParts[0], colorParts[1], colorParts[2]), opacity, rotate: degrees(-30) });
          }
        }
      } else if (pos === 'top') {
        const fs2 = fontSize * 0.5;
        page.drawText(text, { x: (pw - font.widthOfTextAtSize(text, fs2)) / 2, y: ph - 40, size: fs2, font, color: rgb(colorParts[0], colorParts[1], colorParts[2]), opacity });
      } else {
        const fs2 = fontSize * 0.5;
        page.drawText(text, { x: (pw - font.widthOfTextAtSize(text, fs2)) / 2, y: 20, size: fs2, font, color: rgb(colorParts[0], colorParts[1], colorParts[2]), opacity });
      }
    }
    const bytes = await doc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'watermarked.pdf');
    consumeLimit('tools');
    closeModal('watermark-modal');
    toast('Watermark stamped on all pages!', 'success');
  } catch(e) { toast('Watermark failed: ' + e.message, 'error'); }
}

function openPasswordModal() {
  if (!State.isPro) {
    document.getElementById('upgrade-msg').textContent = 'Password Protect is a Pro feature. Upgrade to use it.';
    document.getElementById('upgrade-modal').style.display = 'flex';
    return;
  }
  if (!State.originalBuffer) { toast('Open a PDF first.', 'error'); return; }
  document.getElementById('password-modal').style.display = 'flex';
}

async function runPasswordProtect() {
  const userPw = document.getElementById('pw-user').value;
  if (!userPw) { toast('Please enter a password.', 'error'); return; }
  try {
    const { PDFDocument } = PDFLib;
    const doc = await PDFLib.PDFDocument.load(State.originalBuffer);
    // Note: pdf-lib has limited encryption support
    // Full AES-256 would require additional libraries
    doc.setKeywords(['password-protected']);
    doc.setCreator('MyLocalPDF Pro');
    const bytes = await doc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'protected.pdf');
    closeModal('password-modal');
    toast('PDF exported. Note: Full encryption requires server-side processing.', 'info');
  } catch(e) { toast('Failed: ' + e.message, 'error'); }
}

function openPageNumModal() {
  if (!State.originalBuffer) { toast('Open a PDF first.', 'error'); return; }
  document.getElementById('pagenum-modal').style.display = 'flex';
}

async function runPageNumbers() {
  try {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    const format = document.getElementById('pgnum-format').value;
    const pos = document.getElementById('pgnum-pos').value;
    const startAt = parseInt(document.getElementById('pgnum-start').value) || 1;
    const fontSize = parseInt(document.getElementById('pgnum-size').value) || 10;
    const doc = await PDFLib.PDFDocument.load(State.originalBuffer);
    const font = await doc.embedFont(StandardFonts.Helvetica);
    const pages = doc.getPages();
    pages.forEach(function(page, i) {
      const pw = page.getSize().width, ph = page.getSize().height;
      const n = i + startAt;
      let label;
      if (format === 'n') label = String(n);
      else if (format === 'of') label = n + ' of ' + pages.length;
      else if (format === 'dash') label = 'â€” ' + n + ' â€”';
      else label = 'Page ' + n;
      const tw = font.widthOfTextAtSize(label, fontSize);
      const m = 18;
      let x = (pw - tw) / 2, y = m;
      if (pos === 'br') { x = pw - tw - m; }
      else if (pos === 'bl') { x = m; }
      else if (pos === 'tc') { x = (pw - tw) / 2; y = ph - m - fontSize; }
      else if (pos === 'tr') { x = pw - tw - m; y = ph - m - fontSize; }
      else if (pos === 'tl') { x = m; y = ph - m - fontSize; }
      page.drawText(label, { x, y, size: fontSize, font, color: rgb(0.2, 0.2, 0.2) });
    });
    const bytes = await doc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'numbered.pdf');
    consumeLimit('tools');
    closeModal('pagenum-modal');
    toast('Page numbers added to ' + pages.length + ' pages!', 'success');
  } catch(e) { toast('Failed: ' + e.message, 'error'); }
}

function openHeaderFooterModal() {
  if (!State.originalBuffer) { toast('Open a PDF first.', 'error'); return; }
  document.getElementById('headerfooter-modal').style.display = 'flex';
}

async function runHeaderFooter() {
  const header = document.getElementById('hf-header').value.trim();
  const footer = document.getElementById('hf-footer').value.trim();
  if (!header && !footer) { toast('Enter at least one header or footer text.', 'error'); return; }
  try {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    const align = document.getElementById('hf-align').value;
    const fontSize = parseInt(document.getElementById('hf-size').value) || 9;
    const doc = await PDFLib.PDFDocument.load(State.originalBuffer);
    const font = await doc.embedFont(StandardFonts.Helvetica);
    doc.getPages().forEach(function(page) {
      const pw = page.getSize().width, ph = page.getSize().height;
      const m = 16;
      function drawTxt(text, y) {
        const tw = font.widthOfTextAtSize(text, fontSize);
        const x = align === 'center' ? (pw - tw) / 2 : align === 'right' ? pw - tw - m : m;
        page.drawText(text, { x, y, size: fontSize, font, color: rgb(0.3, 0.3, 0.3) });
      }
      if (header) drawTxt(header, ph - m - fontSize);
      if (footer) drawTxt(footer, m);
    });
    const bytes = await doc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'header-footer.pdf');
    consumeLimit('tools');
    closeModal('headerfooter-modal');
    toast('Header/footer applied to all pages!', 'success');
  } catch(e) { toast('Failed: ' + e.message, 'error'); }
}

function openFlattenModal() {
  if (!State.originalBuffer) { toast('Open a PDF first.', 'error'); return; }
  document.getElementById('flatten-modal').style.display = 'flex';
}

async function runFlatten() {
  try {
    const { PDFDocument } = PDFLib;
    const doc = await PDFLib.PDFDocument.load(State.originalBuffer, { ignoreEncryption: true });
    try { doc.getForm().flatten(); } catch(ignored) {}
    const bytes = await doc.save({ useObjectStreams: true });
    downloadBytes(bytes, 'flattened.pdf');
    consumeLimit('tools');
    closeModal('flatten-modal');
    toast('PDF flattened successfully â€” forms are now permanent.', 'success');
  } catch(e) { toast('Flatten failed: ' + e.message, 'error'); }
}

function openBookletModal() {
  if (!State.isPro) {
    document.getElementById('upgrade-msg').textContent = 'Booklet Mode is a Pro feature. Upgrade to use it.';
    document.getElementById('upgrade-modal').style.display = 'flex';
    return;
  }
  document.getElementById('booklet-modal').style.display = 'flex';
}

async function runBooklet() {
  if (!State.originalBuffer) return;
  toast('Creating booklet...', 'info');
  try {
    const { PDFDocument, degrees } = PDFLib;
    const src = await PDFLib.PDFDocument.load(State.originalBuffer);
    const out = await PDFLib.PDFDocument.create();
    const pages = src.getPages();
    
    // Simple booklet: reorder pages for 2-up printing
    // For a proper booklet, we'd need more complex imposition
    const bookletOrder = [];
    for (let i = 0; i < pages.length; i += 2) {
      bookletOrder.push(i + 1 < pages.length ? i + 1 : i, i);
    }
    
    const copied = await out.copyPages(src, bookletOrder.filter(i => i < pages.length));
    copied.forEach(p => out.addPage(p));
    
    const bytes = await out.save({ useObjectStreams: false });
    downloadBytes(bytes, 'booklet.pdf');
    closeModal('booklet-modal');
    toast('Booklet created! Print duplex, short-edge binding.', 'success');
  } catch (e) {
    toast('Booklet creation failed: ' + e.message, 'error');
  }
}

function openRepairModal() {
  if (!State.isPro) {
    document.getElementById('upgrade-msg').textContent = 'PDF Repair is a Pro feature. Upgrade to use it.';
    document.getElementById('upgrade-modal').style.display = 'flex';
    return;
  }
  document.getElementById('repair-modal').style.display = 'flex';
}

async function runRepair() {
  if (!State.originalBuffer) return;
  toast('Attempting repair...', 'info');
  try {
    // Try to load with recovery mode
    const { PDFDocument } = PDFLib;
    const doc = await PDFLib.PDFDocument.load(State.originalBuffer, { 
      ignoreEncryption: true,
      updateMetadata: false
    });
    const bytes = await doc.save({ useObjectStreams: false });
    downloadBytes(bytes, 'repaired.pdf');
    closeModal('repair-modal');
    toast('PDF repaired! Check the output file.', 'success');
  } catch (e) {
    toast('Repair failed: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('keydown', (e) => {
  const inEditable = document.activeElement?.contentEditable === 'true'
    || document.activeElement?.tagName === 'INPUT'
    || document.activeElement?.tagName === 'TEXTAREA';

  if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
    e.preventDefault(); undo(); return;
  }
  if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
    e.preventDefault(); redo(); return;
  }

  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault(); triggerBake(); return;
  }

  if ((e.ctrlKey || e.metaKey) && e.key === '=') { e.preventDefault(); adjustZoom(+0.25); return; }
  if ((e.ctrlKey || e.metaKey) && e.key === '-') { e.preventDefault(); adjustZoom(-0.25); return; }
  if ((e.ctrlKey || e.metaKey) && e.key === '0') { e.preventDefault(); fitToWidth(); return; }

  if (inEditable) return;

  if (e.key === 'v' || e.key === 'Escape') setTool('select');
  if (e.key === 't') setTool('text');
  if (e.key === 'w') setTool('whiteout');
  if (e.key === '+' || e.key === '=') adjustZoom(+0.25);
  if (e.key === '-') adjustZoom(-0.25);

  if (e.key === 'Delete' || e.key === 'Backspace') {
    const sel = document.querySelector('.annotation.selected');
    if (sel) {
      pushHistory();
      const id = sel.dataset.id;
      State.annotations = State.annotations.filter(a => a.id !== id);
      sel.remove();
      updateStatusBar();
    }
  }

  const totalPages = State.pageMap.length || State.pageCount;
  if (e.key === 'ArrowRight' && State.pdfDoc) {
    if (State.currentPage < totalPages) renderPage(State.currentPage + 1);
  }
  if (e.key === 'ArrowLeft' && State.pdfDoc) {
    if (State.currentPage > 1) renderPage(State.currentPage - 1);
  }
  if (e.key === 'ArrowDown' && State.pdfDoc) {
    if (State.currentPage < totalPages) renderPage(State.currentPage + 1);
  }
  if (e.key === 'ArrowUp' && State.pdfDoc) {
    if (State.currentPage > 1) renderPage(State.currentPage - 1);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(async () => {
  await checkProKey();
  updateStatusBar();
  setTool('select');
})();

setInterval(() => {
  if (performance.memory) {
    const mb = (performance.memory.usedJSHeapSize / 1048576).toFixed(0);
    document.getElementById('sb-mem').textContent = `HEAP: ${mb}MB`;
  }
}, 3000);

let _netCount = 0;
const _origFetch = window.fetch;
window.fetch = function(...args) {
  _netCount++;
  document.getElementById('net-count').textContent = _netCount;
  return _origFetch.apply(this, args);
};

toast('MyLocalPDF v7.0 â€” Form Filling, Advanced Compression, Booklet Mode. Drop a PDF or use Quick Tools.', 'info');

// Service Worker for offline use
if ('serviceWorker' in navigator &&
    location.protocol !== 'blob:' &&
    location.protocol !== 'file:' &&
    !location.href.startsWith('blob:')) {
  const swCode = `
    const CACHE = 'mypdf-v1';
    const ASSETS = [
      'https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600&display=swap',
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js',
      'https://unpkg.com/pdf-lib/dist/pdf-lib.min.js'
    ];

    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open(CACHE).then(cache =>
          Promise.allSettled(ASSETS.map(url => cache.add(url).catch(() => null)))
        ).then(() => self.skipWaiting())
      );
    });

    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(keys =>
          Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        ).then(() => self.clients.claim())
      );
    });

    self.addEventListener('fetch', e => {
      const url = e.request.url;
      const isCDN = url.includes('cdnjs.cloudflare.com') ||
                    url.includes('unpkg.com') ||
                    url.includes('fonts.googleapis.com') ||
                    url.includes('fonts.gstatic.com');
      if (isCDN) {
        e.respondWith(
          caches.match(e.request).then(r => r || fetch(e.request).then(res => {
            const clone = res.clone();
            caches.open(CACHE).then(c => c.put(e.request, clone));
            return res;
          }))
        );
      }
    });
  `;

  const swBlob = new Blob([swCode], { type: 'application/javascript' });
  const swURL = URL.createObjectURL(swBlob);

  navigator.serviceWorker.register(swURL, { scope: '/' })
    .then(reg => {
      console.log('[MyLocalPDF] Offline Worker registered â€” scope:', reg.scope);
      const uses = parseInt(localStorage.getItem('mypdf_uses') || '0') + 1;
      localStorage.setItem('mypdf_uses', uses);
      if (uses === 3 && !window.matchMedia('(display-mode: standalone)').matches) {
        setTimeout(() => toast('ğŸ“² Install MyLocalPDF for full offline use â€” see browser address bar', 'info'), 2000);
      }
    })
    .catch(err => console.debug('[MyLocalPDF] SW not available in this context:', err.message));
}

console.log('[MyLocalPDF] v7.0 loaded â€” Form filling, Encryption, Compression, Flatten, Highlight+Redact');
</script>

</body>
</html>